<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>IsivoltPro - Control de Inventario</title>
<meta name="description" content="Control inteligente de inventario con QR, gestiÃ³n de herramientas y personal">
<meta name="theme-color" content="#1e3c72">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="IsivoltPro">
<link rel="manifest" id="manifest-placeholder">
<link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>âš¡</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e3c72'/><text y='75' x='50' text-anchor='middle' font-size='60' fill='white'>âš¡</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f4f8;min-height:100vh}

/* â”€â”€ HEADER â”€â”€ */
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.3)}
.header h1{color:#fff;font-size:20px;font-weight:700}
.header-sub{color:rgba(255,255,255,.8);font-size:11px}
.header-logo{width:42px;height:42px;background:rgba(255,255,255,.15);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}

/* â”€â”€ MENÃš CONFIGURACIÃ“N â”€â”€ */
.settings-menu{position:fixed;top:70px;right:16px;background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.2);padding:8px;min-width:260px;z-index:200;display:none;animation:slideIn .25s ease}
.settings-menu.show{display:block}
.settings-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;cursor:pointer;transition:all .2s;font-size:14px;color:#333;border:none;background:none;width:100%;text-align:left}
.settings-item:hover{background:#f0f4ff}
.settings-item-icon{font-size:20px;width:32px;display:flex;align-items:center;justify-content:center}
.settings-item-text{flex:1}
.settings-item-label{font-weight:600;font-size:13px;display:block}
.settings-item-desc{font-size:11px;color:#888;margin-top:2px}
.settings-divider{height:1px;background:#e8ecf0;margin:6px 0}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;background:#fff;border-bottom:2px solid #e8ecf0;position:sticky;top:60px;z-index:99;overflow-x:auto}
.tab{flex:0 0 auto;padding:13px 16px;border:none;background:none;font-size:12px;color:#888;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;font-weight:500;transition:all .2s}
.tab.active{color:#1e3c72;border-bottom-color:#1e3c72;font-weight:700;background:#f8f9ff}
.tab-badge{background:#e74c3c;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;margin-left:4px}

.content{padding:16px;max-width:680px;margin:0 auto}
.tab-content{display:none}.tab-content.active{display:block}

/* â”€â”€ CARDS â”€â”€ */
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
.card-title{font-size:14px;font-weight:700;color:#1e3c72;margin-bottom:12px;display:flex;align-items:center;gap:6px}

/* â”€â”€ KPIs â”€â”€ */
.kpi-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
.kpi{border-radius:14px;padding:16px;color:#fff;position:relative;overflow:hidden}
.kpi-val{font-size:36px;font-weight:800;line-height:1}
.kpi-lbl{font-size:12px;opacity:.9;margin-top:4px}
.kpi-bar{height:5px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:10px;overflow:hidden}
.kpi-bar-fill{height:100%;background:rgba(255,255,255,.9);border-radius:3px;transition:width .5s}
.kpi-blue{background:linear-gradient(135deg,#1e3c72,#2a5298)}
.kpi-green{background:linear-gradient(135deg,#27ae60,#1e8449)}
.kpi-red{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.kpi-orange{background:linear-gradient(135deg,#f39c12,#d35400)}

/* â”€â”€ TÃ‰CNICOS CON HERRAMIENTAS (hero dashboard) â”€â”€ */
.tecnico-card{background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.07);border-left:5px solid #e74c3c;display:flex;gap:12px;align-items:flex-start}
.tecnico-card.libre{border-left-color:#27ae60;opacity:.7}
.tecnico-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;flex-shrink:0}
.tecnico-info{flex:1;min-width:0}
.tecnico-name{font-weight:700;font-size:15px;color:#1a1a2e;margin-bottom:2px}
.tecnico-dept{font-size:12px;color:#888;margin-bottom:6px}
.herramienta-tag{display:inline-flex;align-items:center;gap:5px;background:#fff3e0;color:#e65100;border:1px solid #ffcc80;border-radius:20px;padding:4px 10px;font-size:12px;font-weight:600;margin:2px;cursor:pointer;transition:all .2s}
.herramienta-tag:hover{background:#ffe0b2}
.herramienta-tag.critico{background:#ffebee;color:#c62828;border-color:#ef9a9a}
.dias-badge{background:#e74c3c;color:#fff;border-radius:10px;padding:2px 7px;font-size:10px;font-weight:700}
.dias-badge.ok{background:#27ae60}
.dias-badge.warn{background:#f39c12}
.tecnico-libre{color:#27ae60;font-size:13px;font-weight:600}
.tecnico-phone{color:#1e3c72;font-size:12px;margin-top:4px;text-decoration:none;display:flex;align-items:center;gap:4px}

/* â”€â”€ SCAN â”€â”€ */
.scan-section{text-align:center;padding:10px 0}
video{width:100%;max-width:400px;border-radius:12px;display:none;margin:12px auto}
.scan-mode-tabs{display:flex;gap:8px;margin-bottom:16px}
.scan-mode-btn{flex:1;padding:12px;border:2px solid #e0e0e0;background:#fff;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;color:#666;transition:all .2s}
.scan-mode-btn.active{border-color:#1e3c72;background:#f0f4ff;color:#1e3c72}
.scan-state-box{background:#f8f9ff;border:2px dashed #c0ccee;border-radius:12px;padding:20px;margin:12px 0;text-align:center}
.scan-state-icon{font-size:50px;margin-bottom:8px}
.scan-pending{background:#fff3e0;border:2px solid #ffb74d;border-radius:12px;padding:14px;margin:10px 0;text-align:left}
.scan-step{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #ffe0b2}
.scan-step:last-child{border-bottom:none}
.step-num{width:28px;height:28px;border-radius:50%;background:#f39c12;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.step-num.done{background:#27ae60}
.step-num.active{background:#1e3c72;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* â”€â”€ MATERIALES â”€â”€ */
.tool-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.07);border-left:4px solid #27ae60}
.tool-card.out{border-left-color:#e74c3c}
.tool-name{font-weight:700;font-size:15px;color:#1a1a2e;margin-bottom:4px}
.tool-meta{font-size:12px;color:#777;display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.tool-meta span{display:flex;align-items:center;gap:3px}
.tag{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.tag-cat{background:#e8f4fd;color:#1e6091}
.tag-avail{background:#d5f5e3;color:#1e8449}
.tag-out{background:#fadbd8;color:#922b21}
.tag-loc{background:#fef9e7;color:#9a7d0a}
.action-row{display:flex;gap:8px;margin-top:10px}

/* â”€â”€ PERSONAL â”€â”€ */
.worker-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.07);display:flex;gap:12px;align-items:flex-start}
.worker-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0}

/* â”€â”€ HISTORIAL â”€â”€ */
.hist-item{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid #f0f0f0}
.hist-item:last-child{border-bottom:none}
.hist-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.hist-dot.out{background:#ffebee}
.hist-dot.in{background:#e8f5e9}

/* â”€â”€ BOTONES â”€â”€ */
.btn{padding:10px 18px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;box-shadow:0 3px 10px rgba(30,60,114,.3)}
.btn-success{background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.btn-ghost{background:#f0f4f8;color:#1e3c72;border:1px solid #d0d8e8}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-full{width:100%;justify-content:center;padding:14px}
.btn:active{transform:scale(.97)}

/* â”€â”€ FORMS â”€â”€ */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:13px;font-weight:600;color:#444;margin-bottom:5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 14px;border:2px solid #e0e8f0;border-radius:8px;font-size:14px;transition:border .2s;background:#fff}
.form-group input:focus,.form-group select:focus{outline:none;border-color:#2a5298}
.search-bar{position:relative;margin-bottom:14px}
.search-bar input{padding-left:38px;background:#f8fafc;border-color:#e8ecf0}
.search-bar::before{content:'ğŸ”';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px}

/* â”€â”€ MODAL â”€â”€ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;align-items:flex-end;justify-content:center}
.modal.active{display:flex}
.modal-box{background:#fff;border-radius:20px 20px 0 0;padding:24px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:18px;font-weight:700;color:#1e3c72;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:#999}

/* â”€â”€ NOTIFICACIÃ“N MEJORADA â”€â”€ */
.notif{position:fixed;top:16px;right:16px;left:16px;max-width:420px;margin:0 auto;background:#fff;padding:14px 18px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.18);display:flex;align-items:center;gap:12px;z-index:2000;animation:slideIn .35s cubic-bezier(.175,.885,.32,1.275)}
@keyframes slideIn{from{transform:translateY(-90px) scale(.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.notif.success{border-left:5px solid #27ae60;background:linear-gradient(135deg,#fff,#f0fff4)}
.notif.error{border-left:5px solid #e74c3c;background:linear-gradient(135deg,#fff,#fff5f5)}
.notif.warning{border-left:5px solid #f39c12;background:linear-gradient(135deg,#fff,#fffbf0)}
.notif.info{border-left:5px solid #2a5298;background:linear-gradient(135deg,#fff,#f0f4ff)}
.notif-icon{font-size:26px;flex-shrink:0}
.notif-text{font-size:14px;color:#333;font-weight:600;line-height:1.4}
.notif-sub{font-size:12px;color:#888;font-weight:400;margin-top:2px}
.notif-close{margin-left:auto;background:none;border:none;font-size:18px;color:#bbb;cursor:pointer;padding:0 4px;flex-shrink:0}

/* â”€â”€ PANTALLA BIENVENIDA â”€â”€ */
.splash{position:fixed;inset:0;background:linear-gradient(135deg,#0d1f4e,#1e3c72,#2a5298);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .7s ease}
.splash.hide{opacity:0;pointer-events:none}
.splash-logo{font-size:72px;animation:logoBounce .9s ease both}
.splash-title{color:#fff;font-size:34px;font-weight:800;margin-top:14px;letter-spacing:2px;text-shadow:0 2px 10px rgba(0,0,0,.3)}
.splash-sub{color:rgba(255,255,255,.7);font-size:14px;margin-top:6px;letter-spacing:1px}
.splash-bar{width:220px;height:5px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:32px;overflow:hidden}
.splash-bar-fill{height:100%;background:linear-gradient(90deg,#74b9ff,#fff);border-radius:3px;animation:loadBar 2s ease forwards}
.splash-dots{display:flex;gap:8px;margin-top:20px}
.splash-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3)}
.splash-dot.active{background:#fff;animation:dotPulse .6s ease infinite alternate}
.splash-dot:nth-child(2){animation-delay:.2s}.splash-dot:nth-child(3){animation-delay:.4s}
@keyframes logoBounce{0%{transform:scale(0) rotate(-30deg)}60%{transform:scale(1.25) rotate(8deg)}80%{transform:scale(.95)}100%{transform:scale(1) rotate(0)}}
@keyframes loadBar{from{width:0}to{width:100%}}
@keyframes dotPulse{from{opacity:.3;transform:scale(.8)}to{opacity:1;transform:scale(1.2)}}

/* â”€â”€ TOGGLE SONIDO â”€â”€ */
.sound-toggle{position:fixed;bottom:22px;right:18px;z-index:500;background:linear-gradient(135deg,#1e3c72,#2a5298);border:none;border-radius:50%;width:52px;height:52px;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 4px 18px rgba(30,60,114,.45);transition:all .25s;display:flex;align-items:center;justify-content:center}
.sound-toggle:active{transform:scale(.88)}
.sound-toggle.muted{background:linear-gradient(135deg,#999,#666);box-shadow:0 4px 12px rgba(0,0,0,.2)}

/* â”€â”€ CHART â”€â”€ */
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-label{width:110px;font-size:12px;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}
.bar-track{flex:1;height:22px;background:#f0f4f8;border-radius:4px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,#1e3c72,#2a5298);border-radius:4px;display:flex;align-items:center;padding:0 8px;color:#fff;font-size:11px;font-weight:700;min-width:28px;transition:width .4s}

/* â”€â”€ QUICK ACTIONS â”€â”€ */
.qa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px}
.qa-btn{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;border:none;border-radius:12px;padding:16px 10px;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;box-shadow:0 3px 10px rgba(30,60,114,.25)}
.qa-btn:active{transform:scale(.96)}
.qa-icon{font-size:26px;display:block;margin-bottom:6px}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:40px 20px;color:#aaa}
.empty-icon{font-size:48px;margin-bottom:10px}

/* â”€â”€ ALERT ITEMS â”€â”€ */
.alert-box{background:#fff9e6;border:1px solid #ffd54f;border-left:4px solid #f39c12;border-radius:10px;padding:12px;margin-bottom:10px}
.alert-box.critical{background:#ffebee;border-color:#ef9a9a;border-left-color:#e74c3c}
.alert-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.alert-btn{padding:5px 12px;border-radius:6px;border:1px solid currentColor;background:#fff;font-size:12px;font-weight:600;cursor:pointer}

/* â”€â”€ FOTO HERRAMIENTA â”€â”€ */
.photo-capture{border:2px dashed #d0d8e8;border-radius:12px;padding:16px;text-align:center;background:#f8fafc;margin-bottom:14px;cursor:pointer;transition:all .2s}
.photo-capture:hover{border-color:#2a5298;background:#f0f4ff}
.photo-capture.has-photo{border-style:solid;border-color:#27ae60;background:#f0fff4;padding:8px}
.photo-preview{width:100%;max-width:200px;border-radius:8px;margin:8px auto;display:block}
.photo-thumb{width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #e0e8f0;cursor:pointer;transition:all .2s}
.photo-thumb:hover{transform:scale(1.05);border-color:#2a5298}
.tool-card .photo-thumb{margin-top:8px}

/* â”€â”€ MODAL IMAGEN AMPLIADA â”€â”€ */
.img-modal{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
.img-modal.active{display:flex}
.img-modal img{max-width:100%;max-height:90vh;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,.5)}
.img-modal-close{position:absolute;top:20px;right:20px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);color:#fff;font-size:28px;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}

/* â”€â”€ BOTONES SCANNER â”€â”€ */
.scanner-btns{display:flex;gap:8px;margin-bottom:14px}
.scanner-btn{flex:1;padding:12px;border:2px solid #e0e8f0;background:#fff;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px}
.scanner-btn.active{border-color:#2a5298;background:#f0f4ff;color:#1e3c72}
.scanner-btn:hover{border-color:#2a5298}

/* â”€â”€ INSTALL PROMPT â”€â”€ */
.install-prompt{position:fixed;bottom:80px;left:16px;right:16px;max-width:400px;margin:0 auto;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:14px 18px;border-radius:14px;box-shadow:0 8px 30px rgba(30,60,114,.4);z-index:600;display:none;animation:slideUp .4s ease}
.install-prompt.show{display:flex}
.install-prompt-icon{font-size:32px;margin-right:12px}
.install-prompt-text{flex:1}
.install-prompt-title{font-weight:700;font-size:14px;margin-bottom:3px}
.install-prompt-sub{font-size:12px;opacity:.85}
.install-btn{background:#fff;color:#1e3c72;border:none;padding:8px 16px;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;margin-left:8px}
.install-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0 6px;opacity:.7}

/* â”€â”€ MANTENIMIENTO BADGE â”€â”€ */
.maint-badge{display:inline-flex;align-items:center;gap:4px;background:#fff3e0;color:#e65100;border:1px solid #ffcc80;border-radius:12px;padding:3px 8px;font-size:11px;font-weight:600;margin-left:6px}
.maint-badge.due{background:#ffebee;color:#c62828;border-color:#ef9a9a}
.maint-badge.ok{background:#e8f5e9;color:#2e7d32;border-color:#a5d6a7}

/* â”€â”€ SYNC INDICATOR â”€â”€ */
.sync-indicator{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;box-shadow:0 4px 15px rgba(39,174,96,.4);z-index:600;display:none;animation:slideUp .3s ease}
.sync-indicator.show{display:flex;align-items:center;gap:8px}
.sync-spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ DASHBOARD MEJORADO â”€â”€ */
.dash-section{margin-bottom:20px}
.dash-section-title{font-size:15px;font-weight:700;color:#1e3c72;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.dash-section-title-icon{font-size:18px}
.stat-mini{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;padding:10px 14px;border-radius:10px;margin-bottom:8px;border-left:3px solid #2a5298}
.stat-mini-label{font-size:12px;color:#888}
.stat-mini-value{font-size:18px;font-weight:800;color:#1e3c72}

/* â”€â”€ GOOGLE DRIVE MODAL â”€â”€ */
.gdrive-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;display:none;align-items:center;justify-content:center}
.gdrive-modal.active{display:flex}
.gdrive-box{background:#fff;border-radius:20px;padding:24px;width:90%;max-width:450px;max-height:85vh;overflow-y:auto}
.gdrive-title{font-size:18px;font-weight:700;color:#1e3c72;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.gdrive-status{background:#f0f4ff;border:2px solid #c0ccee;border-radius:12px;padding:14px;margin-bottom:16px;text-align:center}
.gdrive-status.connected{background:#e8f5e9;border-color:#a5d6a7}
.gdrive-status.error{background:#ffebee;border-color:#ef9a9a}
.gdrive-btn{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;transition:all .2s}
.gdrive-btn-primary{background:linear-gradient(135deg,#4285f4,#1a73e8);color:#fff}
.gdrive-btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(66,133,244,.3)}
.gdrive-btn-secondary{background:#f0f4ff;color:#1e3c72;border:2px solid #c0ccee}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:400px){.kpi-val{font-size:28px}.tecnico-name{font-size:14px}}
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div class="splash" id="splash">
  <div class="splash-logo">âš¡</div>
  <div class="splash-title">IsivoltPro</div>
  <div class="splash-sub">Control Inteligente de Inventario</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
  <div class="splash-dots">
    <div class="splash-dot active"></div>
    <div class="splash-dot active"></div>
    <div class="splash-dot active"></div>
  </div>
</div>

<!-- BOTÃ“N SONIDO -->
<button class="sound-toggle" id="soundBtn" onclick="toggleSound()" title="Activar/desactivar sonido">ğŸ”Š</button>

<!-- INDICADOR SINCRONIZACIÃ“N -->
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-spinner"></div>
  <span id="syncText">Sincronizando...</span>
</div>

<!-- INSTALL PROMPT PWA -->
<div class="install-prompt" id="installPrompt">
  <div class="install-prompt-icon">ğŸ“±</div>
  <div class="install-prompt-text">
    <div class="install-prompt-title">Instalar IsivoltPro</div>
    <div class="install-prompt-sub">Acceso rÃ¡pido desde tu pantalla de inicio</div>
  </div>
  <button class="install-btn" id="installBtn">Instalar</button>
  <button class="install-close" onclick="document.getElementById('installPrompt').classList.remove('show')">âœ•</button>
</div>

<!-- MODAL IMAGEN AMPLIADA -->
<div class="img-modal" id="imgModal" onclick="closeImageModal()">
  <button class="img-modal-close">âœ•</button>
  <img id="imgModalImg" src="" alt="Imagen ampliada">
</div>

<!-- HEADER -->
<div class="header">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="header-logo">âš¡</div>
    <div>
      <div style="color:#fff;font-size:20px;font-weight:800;line-height:1.2">IsivoltPro</div>
      <div class="header-sub">Control Inteligente</div>
    </div>
  </div>
  <button onclick="openSettingsMenu()" style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:8px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center">
    âš™ï¸
  </button>
</div>

<!-- MENÃš CONFIGURACIÃ“N -->
<div class="settings-menu" id="settingsMenu">
  <button class="settings-item" onclick="toggleSound();closeSettingsMenu()">
    <div class="settings-item-icon" id="sound-icon-menu">ğŸ”Š</div>
    <div class="settings-item-text">
      <span class="settings-item-label">Sonido</span>
      <span class="settings-item-desc" id="sound-status-menu">Activado</span>
    </div>
  </button>
  
  <button class="settings-item" onclick="openGDriveSync()">
    <div class="settings-item-icon">â˜ï¸</div>
    <div class="settings-item-text">
      <span class="settings-item-label">Sincronizar con Drive</span>
      <span class="settings-item-desc">Backup automÃ¡tico</span>
    </div>
  </button>
  
  <div class="settings-divider"></div>
  
  <button class="settings-item" onclick="exportExcel();closeSettingsMenu()">
    <div class="settings-item-icon">ğŸ“Š</div>
    <div class="settings-item-text">
      <span class="settings-item-label">Exportar Excel</span>
      <span class="settings-item-desc">Descargar reporte completo</span>
    </div>
  </button>
  
  <button class="settings-item" onclick="exportCSV();closeSettingsMenu()">
    <div class="settings-item-icon">ğŸ“„</div>
    <div class="settings-item-text">
      <span class="settings-item-label">Exportar CSV</span>
      <span class="settings-item-desc">Formato compatible</span>
    </div>
  </button>
  
  <div class="settings-divider"></div>
  
  <button class="settings-item" onclick="downloadApp();closeSettingsMenu()">
    <div class="settings-item-icon">ğŸ’¾</div>
    <div class="settings-item-text">
      <span class="settings-item-label">Descargar App</span>
      <span class="settings-item-desc">Guardar archivo HTML</span>
    </div>
  </button>
  
  <button class="settings-item" onclick="clearAllData()">
    <div class="settings-item-icon">ğŸ—‘ï¸</div>
    <div class="settings-item-text">
      <span class="settings-item-label" style="color:#e74c3c">Borrar todos los datos</span>
      <span class="settings-item-desc">AcciÃ³n irreversible</span>
    </div>
  </button>
</div>

<!-- TABS -->
<div class="tabs">

<!-- MODAL GOOGLE DRIVE -->
<div class="gdrive-modal" id="gdriveModal">
  <div class="gdrive-box">
    <div class="gdrive-title">
      <span>â˜ï¸</span>
      <span>SincronizaciÃ³n con Google Drive</span>
    </div>
    
    <div class="gdrive-status" id="gdriveStatus">
      <div style="font-size:40px;margin-bottom:8px" id="gdriveStatusIcon">â˜ï¸</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px" id="gdriveStatusTitle">No conectado</div>
      <div style="font-size:12px;color:#888" id="gdriveStatusDesc">Conecta para hacer backup automÃ¡tico</div>
    </div>
    
    <div id="gdriveActions">
      <button class="gdrive-btn gdrive-btn-primary" onclick="connectGoogleDrive()">
        <span>ğŸ”—</span>
        <span>Conectar con Google Drive</span>
      </button>
      
      <button class="gdrive-btn gdrive-btn-secondary" onclick="manualBackup()">
        <span>ğŸ’¾</span>
        <span>Hacer Backup Manual</span>
      </button>
      
      <button class="gdrive-btn gdrive-btn-secondary" onclick="restoreFromBackup()">
        <span>ğŸ“¥</span>
        <span>Restaurar desde Backup</span>
      </button>
    </div>
    
    <div style="margin-top:16px;padding:12px;background:#f8fafc;border-radius:10px;font-size:12px;color:#666">
      <div style="font-weight:600;margin-bottom:6px">â„¹ï¸ InformaciÃ³n</div>
      <ul style="margin:0;padding-left:18px;line-height:1.6">
        <li>Backup automÃ¡tico cada hora</li>
        <li>Sincroniza materiales, personal e historial</li>
        <li>Restaura en cualquier dispositivo</li>
        <li>Tus datos siempre seguros</li>
      </ul>
    </div>
    
    <button class="btn btn-ghost btn-full" style="margin-top:14px" onclick="closeModal('gdriveModal')">Cerrar</button>
  </div>
</div>

<!-- TABS -->
  <button class="tab active" onclick="switchTab('dashboard',this)">ğŸ“Š Panel</button>
  <button class="tab" onclick="switchTab('scan',this)">ğŸ“· Escanear</button>
  <button class="tab" onclick="switchTab('tools',this)">ğŸ“¦ Materiales</button>
  <button class="tab" onclick="switchTab('workers',this)">ğŸ‘· Personal</button>
  <button class="tab" onclick="switchTab('history',this)">ğŸ“‹ Historial</button>
</div>

<div class="content">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-dashboard" class="tab-content active">

  <div class="kpi-row">
    <div class="kpi kpi-blue">
      <div class="kpi-val" id="kpi-total">0</div>
      <div class="kpi-lbl">ğŸ“¦ Total Materiales</div>
    </div>
    <div class="kpi kpi-green">
      <div class="kpi-val" id="kpi-avail">0</div>
      <div class="kpi-lbl">âœ… Disponibles</div>
      <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-avail-bar"></div></div>
    </div>
    <div class="kpi kpi-red">
      <div class="kpi-val" id="kpi-use">0</div>
      <div class="kpi-lbl">ğŸ”§ En Uso</div>
      <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-use-bar"></div></div>
    </div>
    <div class="kpi kpi-orange">
      <div class="kpi-val" id="kpi-pers">0</div>
      <div class="kpi-lbl">ğŸ‘· Personal Activo</div>
    </div>
  </div>

  <!-- ESTADÃSTICAS RÃPIDAS -->
  <div class="card dash-section">
    <div class="dash-section-title">
      <span class="dash-section-title-icon">ğŸ“Š</span>
      <span>EstadÃ­sticas de Hoy</span>
    </div>
    <div id="today-stats"></div>
  </div>

  <!-- ALERTAS -->
  <div class="card" id="alerts-card" style="display:none">
    <div class="card-title">âš ï¸ AtenciÃ³n requerida <span class="tab-badge" id="alert-count">0</span></div>
    <div id="alerts-body"></div>
  </div>

  <!-- TÃ‰CNICOS CON HERRAMIENTAS â€” bloque principal -->
  <div class="card dash-section">
    <div class="dash-section-title">
      <span class="dash-section-title-icon">ğŸ”§</span>
      <span>Herramientas por TÃ©cnico</span>
    </div>
    <div id="tecnicos-lista"></div>
  </div>

  <!-- GRÃFICO ACTIVIDAD SEMANAL -->
  <div class="card dash-section">
    <div class="dash-section-title">
      <span class="dash-section-title-icon">ğŸ“ˆ</span>
      <span>Actividad Semanal</span>
    </div>
    <div id="weekly-chart" style="display:flex;align-items:flex-end;justify-content:space-around;height:90px;gap:6px;padding-bottom:4px;border-bottom:2px solid #e8ecf0"></div>
    <div style="display:flex;justify-content:space-around;margin-top:4px" id="weekly-labels"></div>
  </div>

  <!-- TOP MATERIALES -->
  <div class="card dash-section">
    <div class="dash-section-title">
      <span class="dash-section-title-icon">ğŸ”¥</span>
      <span>Materiales MÃ¡s Usados</span>
    </div>
    <div id="top-materials"></div>
  </div>

  <!-- ACCIONES RÃPIDAS -->
  <div class="qa-grid">
    <button class="qa-btn" onclick="switchTab('scan',document.querySelectorAll('.tab')[1])">
      <span class="qa-icon">ğŸ“·</span>Escanear QR
    </button>
    <button class="qa-btn" onclick="openAddTool()">
      <span class="qa-icon">â•</span>AÃ±adir Material
    </button>
    <button class="qa-btn" onclick="openGDriveSync()">
      <span class="qa-icon">â˜ï¸</span>Backup
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ESCANEAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-scan" class="tab-content">

  <!-- Modo de escaneo -->
  <div class="scan-mode-tabs">
    <button class="scan-mode-btn active" id="mode-btn-normal" onclick="setScanMode('normal')">
      ğŸ“¦ Modo Normal
    </button>
    <button class="scan-mode-btn" id="mode-btn-tecnico" onclick="setScanMode('tecnico')">
      ğŸ‘· Modo TÃ©cnico
    </button>
  </div>

  <!-- MODO NORMAL -->
  <div id="mode-normal">
    <!-- Selector QR vs Barcode -->
    <div class="scanner-btns">
      <button class="scanner-btn active" id="scan-qr-btn" onclick="setScannerType('qr')">
        ğŸ“± CÃ³digo QR
      </button>
      <button class="scanner-btn" id="scan-barcode-btn" onclick="setScannerType('barcode')">
        ğŸ“Š CÃ³digo de Barras
      </button>
    </div>

    <div class="scan-section">
      <div class="scan-state-box">
        <div class="scan-state-icon">ğŸ“·</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:6px" id="scan-title">Escanear CÃ³digo QR</div>
        <div style="color:#888;font-size:13px" id="scan-subtitle">Escanea el QR de un material para registrar entrada/salida</div>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
      <div id="scanResult"></div>
      <button id="startScanBtn" class="btn btn-primary btn-full" onclick="startScanning()">ğŸ“· Iniciar Escaneo</button>
      <button id="stopScanBtn" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="stopScanning()">â¹ Detener</button>
    </div>
  </div>

  <!-- MODO TÃ‰CNICO: primero escanea tÃ©cnico, luego herramienta -->
  <div id="mode-tecnico" style="display:none">
    <div class="scan-pending" id="tecnico-flow-box">
      <div style="font-weight:700;font-size:15px;color:#e65100;margin-bottom:10px">âš¡ Modo TÃ©cnico â€” Flujo de 2 pasos</div>

      <div class="scan-step">
        <div class="step-num active" id="step1-num">1</div>
        <div>
          <div style="font-weight:600;font-size:13px">Escanear QR del TÃ©cnico</div>
          <div style="font-size:12px;color:#888" id="step1-info">Pide al tÃ©cnico su tarjeta QR personal</div>
        </div>
      </div>
      <div class="scan-step">
        <div class="step-num" id="step2-num">2</div>
        <div>
          <div style="font-weight:600;font-size:13px">Escanear QR de la Herramienta</div>
          <div style="font-size:12px;color:#888" id="step2-info">Escanea el QR pegado en la herramienta</div>
        </div>
      </div>
    </div>

    <div class="scan-section">
      <video id="video2" autoplay playsinline></video>
      <canvas id="canvas2" style="display:none"></canvas>
      <div id="scanResult2"></div>
      <button id="startScanBtn2" class="btn btn-primary btn-full" onclick="startScanning2()">ğŸ“· Iniciar Escaneo TÃ©cnico</button>
      <button id="stopScanBtn2" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="stopScanning2()">â¹ Detener</button>
      <button id="resetFlowBtn" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="resetTecnicoFlow()">ğŸ”„ Reiniciar flujo</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATERIALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-tools" class="tab-content">
  <div class="search-bar">
    <input type="text" id="search-tools" placeholder="Buscar material..." oninput="renderTools()">
  </div>
  <button class="btn btn-primary btn-full" style="margin-bottom:14px" onclick="openAddTool()">â• AÃ±adir Material</button>
  <div id="tools-list"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PERSONAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-workers" class="tab-content">
  <div class="search-bar">
    <input type="text" id="search-workers" placeholder="Buscar personal..." oninput="renderWorkers()">
  </div>
  <button class="btn btn-primary btn-full" style="margin-bottom:14px" onclick="openAddWorker()">â• AÃ±adir Personal</button>
  <div id="workers-list"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-history" class="tab-content">
  <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
    <select id="filter-type" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
      <option value="">Todos los movimientos</option>
      <option value="out">Solo Salidas</option>
      <option value="in">Solo Entradas</option>
    </select>
    <select id="filter-worker" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
      <option value="">Todo el personal</option>
    </select>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <input type="date" id="filter-from" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
    <input type="date" id="filter-to" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <button class="btn btn-primary" style="flex:1" onclick="exportExcel()">ğŸ“Š Excel</button>
    <button class="btn btn-ghost" style="flex:1" onclick="exportCSV()">ğŸ“„ CSV</button>
  </div>
  <div id="history-stats" class="card" style="margin-bottom:14px"></div>
  <div id="history-list"></div>
</div>

</div><!-- /content -->

<!-- â•â•â•â•â•â•â•â•â•â• MODALES â•â•â•â•â•â•â•â•â•â• -->

<!-- Modal Movimiento -->
<div class="modal" id="modal-movement">
  <div class="modal-box">
    <div class="modal-title">
      <span id="mv-title">Registrar Movimiento</span>
      <button class="modal-close" onclick="closeModal('modal-movement')">âœ•</button>
    </div>
    <div id="mv-content"></div>
  </div>
</div>

<!-- Modal AÃ±adir Material -->
<div class="modal" id="modal-tool">
  <div class="modal-box">
    <div class="modal-title">
      <span>ğŸ“¦ AÃ±adir Material</span>
      <button class="modal-close" onclick="closeModal('modal-tool')">âœ•</button>
    </div>
    
    <!-- CAPTURA DE FOTO -->
    <div class="photo-capture" id="photoCapture" onclick="capturePhoto()">
      <div id="photoPlaceholder">
        <div style="font-size:40px;margin-bottom:8px">ğŸ“·</div>
        <div style="font-weight:600;font-size:14px;color:#1e3c72">AÃ±adir Foto (Opcional)</div>
        <div style="font-size:12px;color:#888;margin-top:4px">Toca para capturar con la cÃ¡mara</div>
      </div>
      <img id="photoPreview" class="photo-preview" style="display:none">
      <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelected(event)">
    </div>
    
    <div class="form-group"><label>Nombre *</label><input id="t-name" placeholder="Ej: Taladro Bosch"></div>
    <div class="form-group"><label>CÃ³digo *</label><input id="t-code" placeholder="Ej: MAT-001"></div>
    <div class="form-group"><label>CategorÃ­a</label>
      <select id="t-cat">
        <option value="">-- Seleccionar --</option>
        <option>Herramientas</option><option>Material ElÃ©ctrico</option>
        <option>Equipos</option><option>Consumibles</option>
        <option>EPIs</option><option>Otro</option>
      </select>
    </div>
    <div class="form-group"><label>UbicaciÃ³n</label><input id="t-loc" placeholder="Ej: AlmacÃ©n A - Estante 3"></div>
    <div class="form-group"><label>DescripciÃ³n</label><input id="t-desc" placeholder="Detalles adicionales"></div>
    
    <!-- MANTENIMIENTO -->
    <div class="form-group">
      <label>Mantenimiento cada (meses) - Opcional</label>
      <input id="t-maint" type="number" min="0" placeholder="Ej: 6 (dejar vacÃ­o si no aplica)">
    </div>
    
    <button class="btn btn-primary btn-full" onclick="saveTool()">ğŸ’¾ Guardar Material</button>
  </div>
</div>

<!-- Modal AÃ±adir Personal -->
<div class="modal" id="modal-worker">
  <div class="modal-box">
    <div class="modal-title">
      <span>ğŸ‘· AÃ±adir Personal</span>
      <button class="modal-close" onclick="closeModal('modal-worker')">âœ•</button>
    </div>
    <div class="form-group"><label>Nombre completo *</label><input id="w-name" placeholder="Ej: Juan GarcÃ­a"></div>
    <div class="form-group"><label>CÃ³digo empleado *</label><input id="w-code" placeholder="Ej: EMP-001"></div>
    <div class="form-group"><label>Departamento</label>
      <select id="w-dept">
        <option value="">-- Seleccionar --</option>
        <option>ElÃ©ctrico</option><option>FontanerÃ­a</option>
        <option>CarpinterÃ­a</option><option>Mantenimiento</option>
        <option>ProducciÃ³n</option><option>AlmacÃ©n</option><option>Otro</option>
      </select>
    </div>
    <div class="form-group"><label>TelÃ©fono</label><input id="w-phone" type="tel" placeholder="612345678"></div>
    <div class="form-group"><label>Email</label><input id="w-email" type="email" placeholder="juan@empresa.com"></div>
    <button class="btn btn-primary btn-full" onclick="saveWorker()">ğŸ’¾ Guardar Personal</button>
  </div>
</div>

<!-- Modal QR -->
<div class="modal" id="modal-qr">
  <div class="modal-box" style="text-align:center">
    <div class="modal-title">
      <span>ğŸ“± CÃ³digo QR</span>
      <button class="modal-close" onclick="closeModal('modal-qr')">âœ•</button>
    </div>
    <div id="qr-item-info" style="margin-bottom:14px"></div>
    <div id="qr-wrapper" style="min-height:280px;display:flex;align-items:center;justify-content:center">
      <div style="color:#aaa">â³ Generando...</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" style="flex:1" onclick="downloadQR()">ğŸ’¾ Descargar</button>
      <button class="btn btn-ghost" style="flex:1" onclick="printQR()">ğŸ–¨ï¸ Imprimir</button>
    </div>
  </div>
</div>

<!-- Modal Devolver herramienta desde tarjeta tÃ©cnico -->
<div class="modal" id="modal-return">
  <div class="modal-box">
    <div class="modal-title">
      <span id="return-title">ğŸ“¥ Devolver Herramienta</span>
      <button class="modal-close" onclick="closeModal('modal-return')">âœ•</button>
    </div>
    <div id="return-content"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tools   = JSON.parse(localStorage.getItem('iv_tools')   || '[]');
let workers = JSON.parse(localStorage.getItem('iv_workers') || '[]');
let history = JSON.parse(localStorage.getItem('iv_history') || '[]');

function save(){
  localStorage.setItem('iv_tools',   JSON.stringify(tools));
  localStorage.setItem('iv_workers', JSON.stringify(workers));
  localStorage.setItem('iv_history', JSON.stringify(history));
}

// Datos de ejemplo si estÃ¡ vacÃ­o
if(!tools.length){
  tools=[
    {id:'t1',name:'Taladro Bosch',code:'MAT-001',category:'Herramientas',location:'AlmacÃ©n A-1',description:'Taladro percutor 750W',status:'available',assignedTo:null},
    {id:'t2',name:'MultÃ­metro Fluke',code:'MAT-002',category:'Equipos',location:'Taller',description:'Digital true RMS',status:'available',assignedTo:null},
    {id:'t3',name:'Cable 2.5mm 100m',code:'MAT-003',category:'Material ElÃ©ctrico',location:'AlmacÃ©n B-5',description:'Unipolar azul',status:'available',assignedTo:null},
    {id:'t4',name:'AmperÃ­metro',code:'MAT-004',category:'Equipos',location:'AlmacÃ©n A-2',description:'Pinza amperimÃ©trica',status:'available',assignedTo:null},
  ];
  workers=[
    {id:'w1',name:'Juan GarcÃ­a',code:'EMP-001',department:'ElÃ©ctrico',phone:'612345678',email:'juan@empresa.com'},
    {id:'w2',name:'MarÃ­a LÃ³pez',code:'EMP-002',department:'Mantenimiento',phone:'698765432',email:'maria@empresa.com'},
    {id:'w3',name:'Carlos Ruiz',code:'EMP-003',department:'ProducciÃ³n',phone:'655111222',email:'carlos@empresa.com'},
  ];
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='tools')     renderTools();
  if(name==='workers')   renderWorkers();
  if(name==='history')   renderHistory();
  if(name==='scan')      resetTecnicoFlow();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const total  = tools.length;
  const avail  = tools.filter(t=>t.status==='available').length;
  const inUse  = tools.filter(t=>t.status==='out').length;
  const active = new Set(tools.filter(t=>t.assignedTo).map(t=>t.assignedTo)).size;

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-avail').textContent = avail;
  document.getElementById('kpi-use').textContent   = inUse;
  document.getElementById('kpi-pers').textContent  = active;

  const pct = total>0 ? inUse/total*100 : 0;
  document.getElementById('kpi-avail-bar').style.width = (100-pct)+'%';
  document.getElementById('kpi-use-bar').style.width   = pct+'%';

  // EstadÃ­sticas de hoy
  renderTodayStats();
  
  renderAlerts();
  renderTecnicos();
  renderWeekly();
  renderTopMaterials();
}

function renderTodayStats(){
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const todayHistory = history.filter(h => new Date(h.date).getTime() >= today);
  
  const outToday = todayHistory.filter(h => h.type === 'out').length;
  const inToday = todayHistory.filter(h => h.type === 'in').length;
  const totalToday = todayHistory.length;
  
  // TÃ©cnico mÃ¡s activo hoy
  const techActivity = {};
  todayHistory.forEach(h => {
    techActivity[h.workerName] = (techActivity[h.workerName] || 0) + 1;
  });
  const topTech = Object.entries(techActivity).sort((a,b) => b[1]-a[1])[0];
  
  const el = document.getElementById('today-stats');
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      <div class="stat-mini">
        <div>
          <div class="stat-mini-label">Salidas</div>
          <div class="stat-mini-value">${outToday}</div>
        </div>
        <div style="font-size:24px">ğŸ“¤</div>
      </div>
      <div class="stat-mini">
        <div>
          <div class="stat-mini-label">Entradas</div>
          <div class="stat-mini-value">${inToday}</div>
        </div>
        <div style="font-size:24px">ğŸ“¥</div>
      </div>
    </div>
    <div class="stat-mini" style="border-left-color:#f39c12">
      <div>
        <div class="stat-mini-label">Total Movimientos Hoy</div>
        <div class="stat-mini-value">${totalToday}</div>
      </div>
      <div style="font-size:24px">ğŸ”„</div>
    </div>
    ${topTech ? `
      <div class="stat-mini" style="border-left-color:#27ae60">
        <div>
          <div class="stat-mini-label">TÃ©cnico mÃ¡s activo hoy</div>
          <div style="font-size:14px;font-weight:700;color:#1e3c72;margin-top:3px">${topTech[0]}</div>
        </div>
        <div style="font-size:24px">ğŸ†</div>
      </div>
    ` : ''}
  `;
}
  document.getElementById('kpi-avail').textContent = avail;
  document.getElementById('kpi-use').textContent   = inUse;
  document.getElementById('kpi-pers').textContent  = active;

  const pct = total>0 ? inUse/total*100 : 0;
  document.getElementById('kpi-avail-bar').style.width = (100-pct)+'%';
  document.getElementById('kpi-use-bar').style.width   = pct+'%';

  renderAlerts();
  renderTecnicos();
  renderWeekly();
  renderTopMaterials();
}

function renderAlerts(){
  const card   = document.getElementById('alerts-card');
  const body   = document.getElementById('alerts-body');
  const badge  = document.getElementById('alert-count');
  const now    = new Date();
  const alerts = [];

  history.forEach(h=>{
    if(h.type!=='out') return;
    const tool = tools.find(t=>t.id===h.toolId);
    if(!tool||tool.status!=='out') return;
    const days = Math.floor((now-new Date(h.date))/(864e5));
    if(days>=5) alerts.push({tool,days,workerName:h.workerName,workerId:h.workerId});
  });

  // Deduplicar por herramienta
  const seen=new Set();
  const uniq = alerts.filter(a=>{ if(seen.has(a.tool.id)) return false; seen.add(a.tool.id); return true; });
  uniq.sort((a,b)=>b.days-a.days);

  badge.textContent = uniq.length;
  if(!uniq.length){ card.style.display='none'; return; }
  card.style.display='block';

  body.innerHTML = uniq.map(a=>{
    const w = workers.find(x=>x.id===a.workerId);
    const cls = a.days>15 ? 'critical' : '';
    return `<div class="alert-box ${cls}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <strong>${a.days>15?'ğŸ”´':'âš ï¸'} ${a.tool.name}</strong>
          <div style="font-size:12px;color:#666;margin-top:2px">TÃ©cnico: <strong>${a.workerName}</strong> Â· Hace ${a.days} dÃ­as</div>
        </div>
        <span style="font-size:11px;font-weight:700;color:${a.days>15?'#c62828':'#e65100'}">${a.days}d</span>
      </div>
      <div class="alert-actions">
        ${w&&w.phone?`<button class="alert-btn" onclick="window.location.href='tel:${w.phone}'" style="color:#1e3c72">ğŸ“ Llamar</button>`:''}
        <button class="alert-btn" onclick="quickReturn('${a.tool.id}')" style="color:#27ae60">ğŸ“¥ Devolver</button>
      </div>
    </div>`;
  }).join('');
}

function renderTecnicos(){
  const el = document.getElementById('tecnicos-lista');
  // TÃ©cnicos con herramientas
  const conHerramientas = workers.map(w=>{
    const assigned = tools.filter(t=>t.assignedTo===w.id);
    return {...w, assigned};
  });
  // Ordenar: primero los que tienen herramientas
  conHerramientas.sort((a,b)=>b.assigned.length-a.assigned.length);

  if(!conHerramientas.length){ el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ‘·</div><div>Sin personal registrado</div></div>'; return; }

  el.innerHTML = conHerramientas.map(w=>{
    const initials = w.name.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const libre = w.assigned.length===0;
    return `<div class="tecnico-card ${libre?'libre':''}">
      <div class="tecnico-avatar">${initials}</div>
      <div class="tecnico-info">
        <div class="tecnico-name">${w.name}</div>
        <div class="tecnico-dept">${w.department||'Sin departamento'} Â· ${w.code}</div>
        ${libre
          ? '<div class="tecnico-libre">âœ… Sin herramientas asignadas</div>'
          : w.assigned.map(t=>{
              const lastOut = [...history].find(h=>h.toolId===t.id&&h.type==='out');
              const days = lastOut ? Math.floor((new Date()-new Date(lastOut.date))/864e5) : 0;
              const cls  = days>15?'critico':'';
              const dcls = days>15?'':'dias-badge '+(days>7?'warn':'ok');
              return `<span class="herramienta-tag ${cls}" onclick="quickReturn('${t.id}')">
                ğŸ”§ ${t.name} <span class="${dcls}" style="${days>15?'background:#c62828;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700':''}">${days}d</span>
              </span>`;
            }).join('')
        }
        ${w.phone?`<a href="tel:${w.phone}" class="tecnico-phone">ğŸ“ ${w.phone}</a>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderWeekly(){
  const chart  = document.getElementById('weekly-chart');
  const labels = document.getElementById('weekly-labels');
  const now    = new Date();
  const days   = ['L','M','X','J','V','S','D'];
  const counts = [0,0,0,0,0,0,0];

  history.forEach(h=>{
    const diff = Math.floor((now-new Date(h.date))/864e5);
    if(diff<7){ const idx=6-diff; if(idx>=0) counts[idx]++; }
  });

  const max = Math.max(...counts,1);
  chart.innerHTML = counts.map((v,i)=>{
    const h = Math.round(v/max*80);
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end">
      <div style="width:100%;background:${v>0?'linear-gradient(180deg,#1e3c72,#2a5298)':'#e8ecf0'};height:${Math.max(h,4)}px;border-radius:4px 4px 0 0;position:relative" title="${v} movimientos">
        ${v>0?`<span style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:700;color:#1e3c72">${v}</span>`:''}
      </div>
    </div>`;
  }).join('');

  const todayIdx = (new Date().getDay()+6)%7;
  labels.innerHTML = counts.map((_,i)=>`<div style="flex:1;text-align:center;font-size:11px;color:${i===todayIdx?'#1e3c72':'#aaa'};font-weight:${i===todayIdx?'700':'400'}">${days[i]}</div>`).join('');
}

function renderTopMaterials(){
  const el = document.getElementById('top-materials');
  const cnt = {};
  history.forEach(h=>{ if(h.type==='out') cnt[h.toolName]=(cnt[h.toolName]||0)+1; });
  const top = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(!top.length){ el.innerHTML='<div style="color:#aaa;font-size:13px;text-align:center;padding:10px">Sin datos de uso aÃºn</div>'; return; }
  const max = top[0][1];
  el.innerHTML = top.map(([name,v])=>`
    <div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${v/max*100}%">${v}</div></div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESCANEO â€” MODO NORMAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let videoStream=null, scanning=false;

async function startScanning(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ showNotif('Tu navegador no soporta cÃ¡mara','error'); return; }
    const vid = document.getElementById('video');
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject=videoStream; vid.style.display='block';
    document.getElementById('startScanBtn').style.display='none';
    document.getElementById('stopScanBtn').style.display='block';
    document.getElementById('scanResult').innerHTML='';
    scanning=true;
    vid.onloadedmetadata=()=>{ vid.play(); scanLoop(); };
  }catch(e){ handleCamError(e,'scanResult','startScanBtn'); }
}
function stopScanning(){
  scanning=false;
  if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
  const vid=document.getElementById('video');
  vid.style.display='none';
  document.getElementById('startScanBtn').style.display='block';
  document.getElementById('stopScanBtn').style.display='none';
}
function scanLoop(){
  if(!scanning) return;
  const vid=document.getElementById('video'), cvs=document.getElementById('canvas');
  const ctx=cvs.getContext('2d');
  if(vid.readyState===vid.HAVE_ENOUGH_DATA){
    cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
    ctx.drawImage(vid,0,0);
    const img=ctx.getImageData(0,0,cvs.width,cvs.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){ playSound('scan'); handleQR(code.data); return; }
  }
  requestAnimationFrame(scanLoop);
}

function handleQR(data){
  stopScanning();
  try{
    const d=JSON.parse(data);
    if(d.type==='tool'){
      const tool=tools.find(t=>t.id===d.id);
      if(tool) openMovementModal(tool);
      else showNotif('Herramienta no encontrada en el sistema','error');
    } else if(d.type==='worker'){
      showNotif(`TÃ©cnico: ${d.name} â€” Usa el Modo TÃ©cnico para vincular herramientas`,'success');
    } else { showNotif('QR no reconocido','error'); }
  }catch(e){ showNotif('QR invÃ¡lido o no compatible','error'); }
}

function handleCamError(e, resultId, btnId){
  let msg='';
  if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError')
    msg='âŒ Permiso denegado. Toca el ğŸ”’ de la barra de direcciÃ³n â†’ Permisos â†’ CÃ¡mara â†’ Permitir â†’ Recarga.';
  else if(e.name==='NotFoundError') msg='âŒ No se encontrÃ³ cÃ¡mara en el dispositivo.';
  else if(e.name==='NotReadableError') msg='âŒ La cÃ¡mara estÃ¡ en uso por otra app.';
  else msg='âŒ Error de cÃ¡mara: '+e.message;
  showNotif(msg,'error');
  if(resultId) document.getElementById(resultId).innerHTML=`<div style="color:#e74c3c;font-size:13px;padding:10px;background:#ffebee;border-radius:8px;margin-top:10px">${msg}</div>`;
  if(btnId) document.getElementById(btnId).style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESCANEO â€” MODO TÃ‰CNICO (2 pasos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scanMode='normal', tecnicoStep=1, tecnicoScanned=null;
let videoStream2=null, scanning2=false;

function setScanMode(mode){
  scanMode=mode;
  document.getElementById('mode-normal').style.display   = mode==='normal'  ?'block':'none';
  document.getElementById('mode-tecnico').style.display  = mode==='tecnico' ?'block':'none';
  document.getElementById('mode-btn-normal').classList.toggle('active',  mode==='normal');
  document.getElementById('mode-btn-tecnico').classList.toggle('active', mode==='tecnico');
  if(mode==='tecnico') resetTecnicoFlow();
}

function resetTecnicoFlow(){
  tecnicoStep=1; tecnicoScanned=null;
  if(scanning2) stopScanning2();
  document.getElementById('step1-num').className='step-num active';
  document.getElementById('step2-num').className='step-num';
  document.getElementById('step1-info').textContent='Pide al tÃ©cnico su tarjeta QR personal';
  document.getElementById('step2-info').textContent='Escanea el QR pegado en la herramienta';
  document.getElementById('scanResult2').innerHTML='';
  document.getElementById('startScanBtn2').style.display='block';
  document.getElementById('startScanBtn2').textContent='ğŸ“· Paso 1: Escanear QR del TÃ©cnico';
  document.getElementById('stopScanBtn2').style.display='none';
  document.getElementById('resetFlowBtn').style.display='none';
}

async function startScanning2(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ showNotif('Tu navegador no soporta cÃ¡mara','error'); return; }
    const vid=document.getElementById('video2');
    videoStream2=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject=videoStream2; vid.style.display='block';
    document.getElementById('startScanBtn2').style.display='none';
    document.getElementById('stopScanBtn2').style.display='block';
    document.getElementById('scanResult2').innerHTML='';
    scanning2=true;
    vid.onloadedmetadata=()=>{ vid.play(); scanLoop2(); };
  }catch(e){ handleCamError(e,'scanResult2','startScanBtn2'); }
}
function stopScanning2(){
  scanning2=false;
  if(videoStream2){ videoStream2.getTracks().forEach(t=>t.stop()); videoStream2=null; }
  document.getElementById('video2').style.display='none';
  document.getElementById('stopScanBtn2').style.display='none';
}
function scanLoop2(){
  if(!scanning2) return;
  const vid=document.getElementById('video2'), cvs=document.getElementById('canvas2');
  const ctx=cvs.getContext('2d');
  if(vid.readyState===vid.HAVE_ENOUGH_DATA){
    cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
    ctx.drawImage(vid,0,0);
    const img=ctx.getImageData(0,0,cvs.width,cvs.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){ playSound('scan'); handleQR2(code.data); return; }
  }
  requestAnimationFrame(scanLoop2);
}

function handleQR2(data){
  stopScanning2();
  try{
    const d=JSON.parse(data);
    if(tecnicoStep===1){
      // Espera QR de tÃ©cnico
      if(d.type!=='worker'){ showNotif('âš ï¸ Escanea el QR del TÃ‰CNICO primero (no de herramienta)','error'); restartStep2Scan(); return; }
      const w=workers.find(x=>x.id===d.id);
      if(!w){ showNotif('TÃ©cnico no encontrado en el sistema','error'); restartStep2Scan(); return; }
      tecnicoScanned=w;
      tecnicoStep=2;
      // Actualizar UI
      document.getElementById('step1-num').className='step-num done';
      document.getElementById('step1-info').textContent=`âœ… TÃ©cnico: ${w.name}`;
      document.getElementById('step2-num').className='step-num active';
      document.getElementById('scanResult2').innerHTML=`
        <div style="background:#e8f5e9;border:1px solid #a5d6a7;border-radius:10px;padding:12px;margin:10px 0;text-align:left">
          <div style="font-weight:700;color:#2e7d32">âœ… TÃ©cnico identificado</div>
          <div style="font-size:13px;color:#555;margin-top:4px">${w.name} Â· ${w.code} Â· ${w.department||'-'}</div>
        </div>`;
      document.getElementById('startScanBtn2').style.display='block';
      document.getElementById('startScanBtn2').textContent='ğŸ“· Paso 2: Escanear QR de la Herramienta';
      document.getElementById('resetFlowBtn').style.display='block';
      showNotif(`TÃ©cnico identificado: ${w.name}`,'success','ğŸ‘·','Ahora escanea la herramienta');
    } else {
      // Espera QR de herramienta
      if(d.type!=='tool'){ showNotif('âš ï¸ Escanea el QR de la HERRAMIENTA','error'); restartStep2Scan(); return; }
      const tool=tools.find(t=>t.id===d.id);
      if(!tool){ showNotif('Herramienta no encontrada en el sistema','error'); restartStep2Scan(); return; }
      // Vincular directamente
      registerTecnicoSalida(tool, tecnicoScanned);
    }
  }catch(e){ showNotif('QR invÃ¡lido','error'); restartStep2Scan(); }
}

function restartStep2Scan(){
  document.getElementById('startScanBtn2').style.display='block';
}

function registerTecnicoSalida(tool, worker){
  if(tool.status==='out'){
    const prev=workers.find(w=>w.id===tool.assignedTo);
    // Si ya la tiene el mismo tÃ©cnico, preguntar devoluciÃ³n
    if(tool.assignedTo===worker.id){
      document.getElementById('scanResult2').innerHTML=`
        <div style="background:#fff3e0;border:1px solid #ffcc80;border-radius:10px;padding:12px;margin:10px 0">
          <div style="font-weight:700;color:#e65100">âš ï¸ ${worker.name} ya tiene esta herramienta</div>
          <div style="font-size:13px;color:#555;margin-top:4px">${tool.name}</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-success" style="flex:1" onclick="doCheckin('${tool.id}');resetTecnicoFlow()">ğŸ“¥ Registrar DevoluciÃ³n</button>
            <button class="btn btn-ghost" style="flex:1" onclick="resetTecnicoFlow()">Cancelar</button>
          </div>
        </div>`;
      return;
    }
    // La tiene otro tÃ©cnico
    document.getElementById('scanResult2').innerHTML=`
      <div style="background:#ffebee;border:1px solid #ef9a9a;border-radius:10px;padding:12px;margin:10px 0">
        <div style="font-weight:700;color:#c62828">âŒ Herramienta en uso</div>
        <div style="font-size:13px;color:#555;margin-top:4px">${tool.name} estÃ¡ asignada a: <strong>${prev?prev.name:'Desconocido'}</strong></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-danger" style="flex:1" onclick="doForcedTransfer('${tool.id}','${worker.id}');resetTecnicoFlow()">ğŸ”„ Transferir a ${worker.name}</button>
          <button class="btn btn-ghost" style="flex:1" onclick="resetTecnicoFlow()">Cancelar</button>
        </div>
      </div>`;
    return;
  }

  // Herramienta disponible â†’ asignar directamente
  doCheckout(tool.id, worker.id);
  document.getElementById('scanResult2').innerHTML=`
    <div style="background:#e8f5e9;border:1px solid #a5d6a7;border-radius:10px;padding:14px;margin:10px 0;text-align:center">
      <div style="font-size:36px;margin-bottom:8px">âœ…</div>
      <div style="font-weight:700;color:#2e7d32;font-size:16px">Â¡Herramienta Asignada!</div>
      <div style="font-size:13px;color:#555;margin-top:6px">
        <strong>${tool.name}</strong><br>â†’ <strong>${worker.name}</strong>
      </div>
      <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="resetTecnicoFlow()">âœ… Nueva OperaciÃ³n</button>
    </div>`;
  showNotif(`${tool.name} â†’ ${worker.name}`,'success','âœ…','AsignaciÃ³n registrada');
}

function doForcedTransfer(toolId, workerId){
  doCheckin(toolId);
  doCheckout(toolId, workerId);
  playSound('transfer');
  showNotif('ğŸ”„ Herramienta transferida correctamente','info','ğŸ”„','ReasignaciÃ³n completada');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOVIMIENTOS (Normal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMovementModal(tool){
  const w = tool.assignedTo ? workers.find(x=>x.id===tool.assignedTo) : null;
  document.getElementById('mv-title').textContent = tool.status==='available' ? 'ğŸ“¤ Registrar Salida' : 'ğŸ“¥ Registrar Entrada';
  document.getElementById('mv-content').innerHTML = tool.status==='available' ? `
    <div class="tool-card" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>ğŸ“ ${tool.code}</span>${tool.location?`<span>ğŸ“ ${tool.location}</span>`:''}</div>
    </div>
    <div class="form-group">
      <label>Asignar a tÃ©cnico *</label>
      <select id="sel-worker">
        <option value="">-- Seleccionar tÃ©cnico --</option>
        ${workers.map(w=>`<option value="${w.id}">${w.name} (${w.code})</option>`).join('')}
      </select>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-movement')">Cancelar</button>
      <button class="btn btn-danger" style="flex:1" onclick="doCheckoutFromModal('${tool.id}')">ğŸ“¤ Confirmar Salida</button>
    </div>` : `
    <div class="tool-card out" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>ğŸ“ ${tool.code}</span></div>
      <div style="font-size:13px;color:#666;margin-top:4px">Asignado a: <strong>${w?w.name:'Desconocido'}</strong></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-movement')">Cancelar</button>
      <button class="btn btn-success" style="flex:1" onclick="doCheckin('${tool.id}');closeModal('modal-movement')">ğŸ“¥ Confirmar Entrada</button>
    </div>`;
  document.getElementById('modal-movement').classList.add('active');
}

function doCheckoutFromModal(toolId){
  const wId=document.getElementById('sel-worker').value;
  if(!wId){ showNotif('Selecciona un tÃ©cnico','error'); return; }
  doCheckout(toolId,wId);
  closeModal('modal-movement');
}

function doCheckout(toolId, workerId){
  const tool=tools.find(t=>t.id===toolId);
  const worker=workers.find(w=>w.id===workerId);
  if(!tool||!worker) return;
  tool.status='out'; tool.assignedTo=workerId;
  history.unshift({id:Date.now().toString(),date:new Date().toISOString(),type:'out',toolId,toolName:tool.name,workerId,workerName:worker.name});
  save(); renderDashboard(); renderTools();
  playSound('checkout');
  showNotif(`ğŸ“¤ ${tool.name} â†’ ${worker.name}`,'success','ğŸ“¤','Herramienta prestada');
}

function doCheckin(toolId){
  const tool=tools.find(t=>t.id===toolId);
  if(!tool) return;
  const worker=workers.find(w=>w.id===tool.assignedTo);
  history.unshift({id:Date.now().toString(),date:new Date().toISOString(),type:'in',toolId,toolName:tool.name,workerId:tool.assignedTo,workerName:worker?worker.name:'-'});
  tool.status='available'; tool.assignedTo=null;
  save(); renderDashboard(); renderTools();
  playSound('checkin');
  showNotif(`ğŸ“¥ ${tool.name} devuelta`,'success','ğŸ“¥','Herramienta disponible de nuevo');
}

function quickReturn(toolId){
  const tool=tools.find(t=>t.id===toolId);
  if(!tool) return;
  const w=tool.assignedTo?workers.find(x=>x.id===tool.assignedTo):null;
  document.getElementById('return-title').textContent='ğŸ“¥ Devolver: '+tool.name;
  document.getElementById('return-content').innerHTML=`
    <div class="tool-card out" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>ğŸ“ ${tool.code}</span>${tool.location?`<span>ğŸ“ ${tool.location}</span>`:''}</div>
      <div style="font-size:13px;color:#666;margin-top:4px">Asignado a: <strong>${w?w.name:'Desconocido'}</strong></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-return')">Cancelar</button>
      <button class="btn btn-success" style="flex:1" onclick="doCheckin('${toolId}');closeModal('modal-return')">ğŸ“¥ Confirmar DevoluciÃ³n</button>
    </div>`;
  document.getElementById('modal-return').classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATERIALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTools(){
  const q=(document.getElementById('search-tools')?.value||'').toLowerCase();
  const el=document.getElementById('tools-list');
  const list=tools.filter(t=>!q||t.name.toLowerCase().includes(q)||t.code.toLowerCase().includes(q)||(t.category||'').toLowerCase().includes(q)||(t.location||'').toLowerCase().includes(q));
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¦</div><div>Sin materiales</div></div>'; return; }
  el.innerHTML=list.map(t=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    const maint = checkMaintenance(t);
    return `<div class="tool-card ${t.status==='out'?'out':''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="tool-name">
            ${t.name}
            ${maint?`<span class="maint-badge ${maint.status}">ğŸ”§ ${maint.text}</span>`:''}
          </div>
        </div>
        <span class="tag ${t.status==='available'?'tag-avail':'tag-out'}">${t.status==='available'?'âœ… Libre':'ğŸ”§ En uso'}</span>
      </div>
      <div class="tool-meta">
        <span>ğŸ“ ${t.code}</span>
        ${t.category?`<span class="tag tag-cat">${t.category}</span>`:''}
        ${t.location?`<span>ğŸ“ ${t.location}</span>`:''}
      </div>
      ${w?`<div style="font-size:13px;color:#e74c3c;font-weight:600;margin-bottom:6px">ğŸ‘· ${w.name}</div>`:''}
      ${t.photo?`<img src="${t.photo}" class="photo-thumb" onclick="showImageModal('${t.photo}')" alt="Foto de ${t.name}">`:''}
      <div class="action-row">
        <button class="btn btn-ghost btn-sm" onclick="showQR('tool','${t.id}')">ğŸ“± QR</button>
        ${t.status==='available'
          ?`<button class="btn btn-danger btn-sm" onclick="openMovementModal(tools.find(x=>x.id==='${t.id}'))">ğŸ“¤ Prestar</button>`
          :`<button class="btn btn-success btn-sm" onclick="doCheckin('${t.id}')">ğŸ“¥ Devolver</button>`}
        ${maint && maint.status==='due'?`<button class="btn btn-ghost btn-sm" onclick="registerMaintenance('${t.id}')">ğŸ”§ Mant.</button>`:''}
        <button class="btn btn-ghost btn-sm" onclick="deleteTool('${t.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function openAddTool(){ 
  currentPhoto = null;
  document.getElementById('photoPreview').style.display='none';
  document.getElementById('photoPlaceholder').style.display='block';
  document.getElementById('photoCapture').classList.remove('has-photo');
  document.getElementById('modal-tool').classList.add('active'); 
}

function saveTool(){
  const name=document.getElementById('t-name').value.trim();
  const code=document.getElementById('t-code').value.trim();
  if(!name||!code){ showNotif('Nombre y CÃ³digo son obligatorios','error'); return; }
  
  const maint = parseInt(document.getElementById('t-maint').value) || null;
  
  const newTool = {
    id: 't'+Date.now(),
    name,
    code,
    category: document.getElementById('t-cat').value,
    location: document.getElementById('t-loc').value.trim(),
    description: document.getElementById('t-desc').value.trim(),
    status: 'available',
    assignedTo: null,
    photo: currentPhoto,
    maintenanceMonths: maint,
    lastMaintenance: maint ? Date.now().toString() : null,
    maintenanceHistory: []
  };
  
  tools.push(newTool);
  save(); closeModal('modal-tool'); renderTools(); renderDashboard();
  
  ['t-name','t-code','t-loc','t-desc','t-maint'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('t-cat').value='';
  currentPhoto = null;
  
  playSound('save');
  showNotif('Material aÃ±adido al inventario','success','ğŸ“¦','Disponible para asignar');
}
function deleteTool(id){
  if(!confirm('Â¿Eliminar este material?')) return;
  tools=tools.filter(t=>t.id!==id); save(); renderTools(); renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWorkers(){
  const q=(document.getElementById('search-workers')?.value||'').toLowerCase();
  const el=document.getElementById('workers-list');
  const list=workers.filter(w=>!q||w.name.toLowerCase().includes(q)||w.code.toLowerCase().includes(q)||(w.department||'').toLowerCase().includes(q));
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ‘·</div><div>Sin personal</div></div>'; return; }
  el.innerHTML=list.map(w=>{
    const assigned=tools.filter(t=>t.assignedTo===w.id);
    const initials=w.name.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    return `<div class="worker-card">
      <div class="worker-avatar">${initials}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:15px">${w.name}</div>
        <div style="font-size:12px;color:#888;margin-bottom:6px">${w.code} Â· ${w.department||'-'}</div>
        ${w.phone?`<a href="tel:${w.phone}" style="color:#1e3c72;font-size:12px;font-weight:600">ğŸ“ ${w.phone}</a><br>`:''}
        ${w.email?`<div style="font-size:12px;color:#888">${w.email}</div>`:''}
        ${assigned.length?`<div style="margin-top:8px">${assigned.map(t=>`<span class="tag tag-out" style="margin:2px">${t.name}</span>`).join('')}</div>`:'<div style="font-size:12px;color:#27ae60;margin-top:6px">âœ… Sin herramientas</div>'}
        <div class="action-row" style="margin-top:10px">
          <button class="btn btn-ghost btn-sm" onclick="showQR('worker','${w.id}')">ğŸ“± QR Personal</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteWorker('${w.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openAddWorker(){ document.getElementById('modal-worker').classList.add('active'); }
function saveWorker(){
  const name=document.getElementById('w-name').value.trim();
  const code=document.getElementById('w-code').value.trim();
  if(!name||!code){ showNotif('Nombre y CÃ³digo son obligatorios','error'); return; }
  workers.push({id:'w'+Date.now(),name,code,department:document.getElementById('w-dept').value,phone:document.getElementById('w-phone').value.trim(),email:document.getElementById('w-email').value.trim()});
  save(); closeModal('modal-worker'); renderWorkers(); renderDashboard();
  ['w-name','w-code','w-phone','w-email'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('w-dept').value='';
  playSound('save');
  showNotif('Personal registrado','success','ğŸ‘·','Ya puede usar el sistema');
}
function deleteWorker(id){
  if(!confirm('Â¿Eliminar este trabajador?')) return;
  workers=workers.filter(w=>w.id!==id); save(); renderWorkers(); renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory(){
  const type   = document.getElementById('filter-type').value;
  const worker = document.getElementById('filter-worker').value;
  const from   = document.getElementById('filter-from').value;
  const to     = document.getElementById('filter-to').value;

  // Poblar select de personal
  const sel=document.getElementById('filter-worker');
  const cur=sel.value;
  sel.innerHTML='<option value="">Todo el personal</option>'+workers.map(w=>`<option value="${w.id}" ${cur===w.id?'selected':''}>${w.name}</option>`).join('');

  let list=history;
  if(type)   list=list.filter(h=>h.type===type);
  if(worker) list=list.filter(h=>h.workerId===worker);
  if(from)   list=list.filter(h=>new Date(h.date)>=new Date(from));
  if(to)     list=list.filter(h=>new Date(h.date)<=new Date(to+'T23:59:59'));

  // Stats
  const outs=list.filter(h=>h.type==='out').length;
  const ins =list.filter(h=>h.type==='in').length;
  document.getElementById('history-stats').innerHTML=`
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div><span style="font-size:22px;font-weight:800;color:#1e3c72">${list.length}</span><div style="font-size:11px;color:#888">Total</div></div>
      <div><span style="font-size:22px;font-weight:800;color:#e74c3c">${outs}</span><div style="font-size:11px;color:#888">Salidas</div></div>
      <div><span style="font-size:22px;font-weight:800;color:#27ae60">${ins}</span><div style="font-size:11px;color:#888">Entradas</div></div>
    </div>`;

  const el=document.getElementById('history-list');
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div><div>Sin registros</div></div>'; return; }
  el.innerHTML='<div class="card">'+list.slice(0,100).map(h=>{
    const d=new Date(h.date);
    return `<div class="hist-item">
      <div class="hist-dot ${h.type}">${h.type==='out'?'ğŸ“¤':'ğŸ“¥'}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:14px">${h.toolName}</div>
        <div style="font-size:12px;color:#888">${h.workerName}</div>
        <div style="font-size:11px;color:#bbb;margin-top:2px">${d.toLocaleDateString('es-ES')} Â· ${d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <span style="font-size:11px;font-weight:700;color:${h.type==='out'?'#e74c3c':'#27ae60'};white-space:nowrap">${h.type==='out'?'SALIDA':'ENTRADA'}</span>
    </div>`;
  }).join('')+'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃ“DIGOS QR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _qrItem=null, _qrType=null;

function showQR(type, id){
  const item = type==='tool' ? tools.find(t=>t.id===id) : workers.find(w=>w.id===id);
  if(!item){ showNotif('Elemento no encontrado','error'); return; }
  _qrItem=item; _qrType=type;

  document.getElementById('qr-item-info').innerHTML=`
    <div style="font-weight:700;font-size:17px;color:#1e3c72">${item.name}</div>
    <div style="font-size:13px;color:#888;margin-top:3px">CÃ³digo: ${item.code}</div>`;

  const wrapper=document.getElementById('qr-wrapper');
  wrapper.innerHTML='<div style="color:#aaa;font-size:14px">â³ Generando QR...</div>';
  document.getElementById('modal-qr').classList.add('active');

  setTimeout(()=>{
    const cvs=document.createElement('canvas');
    cvs.id='qr-canvas';
    cvs.style.borderRadius='10px';
    wrapper.innerHTML=''; wrapper.appendChild(cvs);
    const data={type, id:item.id, name:item.name, code:item.code};
    QRCode.toCanvas(cvs, JSON.stringify(data), {
      width:260, margin:2,
      color:{dark:'#1e3c72', light:'#ffffff'},
      errorCorrectionLevel:'M'
    }, err=>{
      if(err){ wrapper.innerHTML=`<div style="color:#e74c3c">âŒ Error al generar QR<br><small>${err.message}</small><br><br><button class="btn btn-primary" onclick="showQR('${type}','${id}')">ğŸ”„ Reintentar</button></div>`; }
    });
  },120);
}

function downloadQR(){
  const cvs=document.getElementById('qr-canvas');
  if(!cvs){ showNotif('QR aÃºn no generado, espera un momento','error'); return; }
  const a=document.createElement('a');
  a.download=`QR-${_qrItem?.name||'item'}.png`;
  a.href=cvs.toDataURL(); a.click();
  showNotif('âœ… QR descargado','success');
}

function printQR(){
  const cvs=document.getElementById('qr-canvas');
  if(!cvs){ showNotif('QR aÃºn no generado','error'); return; }
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>QR ${_qrItem?.name}</title>
    <style>body{font-family:sans-serif;text-align:center;padding:40px} h2{color:#1e3c72} @media print{button{display:none}}</style></head>
    <body><h2>âš¡ IsivoltPro</h2><img src="${cvs.toDataURL()}" width="250" style="border-radius:8px;border:2px solid #1e3c72"><h2>${_qrItem?.name}</h2>
    <p style="color:#666">CÃ³digo: ${_qrItem?.code}</p><p style="font-size:12px;color:#aaa">Escanea para registrar entrada/salida</p>
    <br><button onclick="window.print()" style="padding:10px 20px;background:#1e3c72;color:#fff;border:none;border-radius:8px;font-size:15px;cursor:pointer">ğŸ–¨ï¸ Imprimir</button></body></html>`);
  w.document.close(); w.focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel(){
  if(!history.length){ showNotif('No hay datos para exportar','error'); return; }
  if(typeof XLSX==='undefined'){
    showNotif('Cargando Excel...','success');
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=exportExcel; document.head.appendChild(s); return;
  }
  const now=new Date(), fh=now.toLocaleDateString('es-ES'), hh=now.toLocaleTimeString('es-ES');
  const dias=['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  const inUse=tools.filter(t=>t.status==='out').length;
  const avail=tools.filter(t=>t.status==='available').length;
  const wb=XLSX.utils.book_new();

  // Resumen
  const matU={};history.forEach(h=>{if(h.type==='out')matU[h.toolName]=(matU[h.toolName]||0)+1;});
  const topM=Object.entries(matU).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const persU={};history.forEach(h=>{persU[h.workerName]=(persU[h.workerName]||0)+1;});
  const topP=Object.entries(persU).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const res=[['ISIVOLTPRO - REPORTE EJECUTIVO'],[`Generado: ${fh} ${hh}`],[''],
    ['METRICAS GENERALES','Valor'],['Total materiales',tools.length],['Disponibles',avail],['En uso',inUse],
    ['% Uso',tools.length>0?((inUse/tools.length*100).toFixed(1)+'%'):'0%'],['Personal registrado',workers.length],
    ['Total movimientos',history.length],['Total salidas',history.filter(h=>h.type==='out').length],['Total entradas',history.filter(h=>h.type==='in').length],
    [''],['TOP 5 MATERIALES MAS USADOS','Salidas'],...topM,[''],['TOP 5 PERSONAL MAS ACTIVO','Movimientos'],...topP];

  // Historial
  const hist=[['HISTORIAL DE MOVIMIENTOS'],[`Total: ${history.length}`],[''],
    ['N','Fecha','Hora','Dia Semana','Tipo','Material','Cod Material','Ubicacion','Tecnico','Cod Empleado','Departamento']];
  history.forEach((h,i)=>{
    const d=new Date(h.date),w=workers.find(x=>x.id===h.workerId),t=tools.find(x=>x.id===h.toolId);
    hist.push([i+1,d.toLocaleDateString('es-ES'),d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
      dias[d.getDay()],h.type==='out'?'SALIDA':'ENTRADA',h.toolName||'-',t?t.code:'-',t?t.location||'-':'-',
      h.workerName||'-',w?w.code:'-',w?w.department||'-':'-']);
  });

  // Inventario
  const inv=[['INVENTARIO ACTUAL'],[`Fecha: ${fh}`],[''],
    ['N','Material','Codigo','Categoria','Ubicacion','Descripcion','Estado','Asignado A','Telefono','Departamento']];
  tools.forEach((t,i)=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    inv.push([i+1,t.name,t.code,t.category||'-',t.location||'-',t.description||'-',
      t.status==='available'?'DISPONIBLE':'EN USO',w?w.name:'-',w?w.phone||'-':'-',w?w.department||'-':'-']);
  });

  // Personal
  const pers=[['LISTADO DE PERSONAL'],[`Fecha: ${fh}`],[''],
    ['N','Nombre','Codigo','Departamento','Telefono','Email','Materiales Asignados','Lista']];
  workers.forEach((w,i)=>{
    const asgn=tools.filter(t=>t.assignedTo===w.id);
    pers.push([i+1,w.name,w.code,w.department||'-',w.phone||'-',w.email||'-',asgn.length,asgn.map(t=>t.name).join(' | ')||'Ninguno']);
  });

  // En uso ahora
  const enUso=[['MATERIALES EN USO AHORA'],[`Fecha: ${fh}  |  En uso: ${inUse}`],[''],
    ['N','Material','Codigo','Categoria','Ubicacion','Tecnico','Telefono','Departamento','Fecha Salida','Dias En Uso']];
  let c=1;
  tools.filter(t=>t.status==='out').forEach(t=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    const last=[...history].find(h=>h.toolId===t.id&&h.type==='out');
    let fs='-',du='-';
    if(last){const dl=new Date(last.date);fs=dl.toLocaleDateString('es-ES');du=Math.floor((now-dl)/864e5);}
    enUso.push([c++,t.name,t.code,t.category||'-',t.location||'-',w?w.name:'-',w?w.phone||'-':'-',w?w.department||'-':'-',fs,du]);
  });
  if(c===1) enUso.push(['No hay materiales en uso']);

  const add=(data,widths,name)=>{
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=widths.map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,name);
  };
  add(res,    [35,18],                           'Resumen');
  add(hist,   [4,12,8,12,10,24,13,18,20,13,14], 'Historial');
  add(inv,    [4,24,13,16,18,20,11,20,13,14],   'Inventario');
  add(pers,   [4,22,13,14,13,26,10,40],         'Personal');
  add(enUso,  [4,24,13,14,18,20,13,14,15,10],   'En Uso Ahora');

  XLSX.writeFile(wb,`IsivoltPro_${fh.replace(/\//g,'-')}.xlsx`);
  playSound('save');
  showNotif(`Excel descargado: ${history.length} movimientos`,'success','ğŸ“Š','5 hojas Â· Listo para abrir');
}

function exportCSV(){
  const BOM='\uFEFF';
  let csv=BOM+'N;Fecha;Hora;Tipo;Material;Codigo;Tecnico;Empleado;Departamento\n';
  history.forEach((h,i)=>{
    const d=new Date(h.date),w=workers.find(x=>x.id===h.workerId),t=tools.find(x=>x.id===h.toolId);
    csv+=[i+1,d.toLocaleDateString('es-ES'),d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
      h.type==='out'?'SALIDA':'ENTRADA',`"${h.toolName||''}"`,t?t.code:'',`"${h.workerName||''}"`,
      w?w.code:'',w?w.department||'':''
    ].join(';')+'\n';
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`IsivoltPro_${new Date().toLocaleDateString('es-ES').replace(/\//g,'-')}.csv`;
  a.click(); showNotif('âœ… CSV descargado','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE SONIDOS (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let soundEnabled = localStorage.getItem('iv_sound') !== 'false';

function getAudioCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playSound(type){
  if(!soundEnabled) return;
  try{
    const ctx = getAudioCtx();
    if(ctx.state === 'suspended') ctx.resume();

    const sounds = {
      // Salida: tono descendente doble (bip-bip grave)
      checkout: ()=>{
        const t = ctx.currentTime;
        [0, 0.18].forEach((delay, i)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, t+delay);
          osc.frequency.exponentialRampToValueAtTime(440, t+delay+0.15);
          gain.gain.setValueAtTime(0.4, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.18);
          osc.start(t+delay); osc.stop(t+delay+0.2);
        });
      },

      // Entrada: tono ascendente doble (bip-bip agudo â€” confirmar)
      checkin: ()=>{
        const t = ctx.currentTime;
        [0, 0.15].forEach((delay)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(440, t+delay);
          osc.frequency.exponentialRampToValueAtTime(880, t+delay+0.12);
          gain.gain.setValueAtTime(0.35, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      },

      // QR escaneado: beep corto tipo pistola lectora
      scan: ()=>{
        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(1200, t);
        osc.frequency.exponentialRampToValueAtTime(900, t+0.08);
        gain.gain.setValueAtTime(0.2, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t+0.1);
        osc.start(t); osc.stop(t+0.12);
      },

      // Error: tono grave de error
      error: ()=>{
        const t = ctx.currentTime;
        [0, 0.22].forEach(delay=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(180, t+delay);
          gain.gain.setValueAtTime(0.3, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.2);
          osc.start(t+delay); osc.stop(t+delay+0.22);
        });
      },

      // Alerta: 3 bips urgentes
      alert: ()=>{
        const t = ctx.currentTime;
        [0, 0.2, 0.4].forEach(delay=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(660, t+delay);
          gain.gain.setValueAtTime(0.35, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      },

      // Bienvenida: melodÃ­a de inicio (do-mi-sol)
      welcome: ()=>{
        const t = ctx.currentTime;
        const notes = [523, 659, 784, 1046]; // C5 E5 G5 C6
        notes.forEach((freq, i)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, t + i*0.12);
          gain.gain.linearRampToValueAtTime(0.3, t + i*0.12 + 0.04);
          gain.gain.exponentialRampToValueAtTime(0.001, t + i*0.12 + 0.22);
          osc.start(t + i*0.12);
          osc.stop(t + i*0.12 + 0.25);
        });
      },

      // Guardar/Ã©xito: ding agradable
      save: ()=>{
        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(784, t);
        osc.frequency.exponentialRampToValueAtTime(1046, t+0.1);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t+0.3);
        osc.start(t); osc.stop(t+0.35);
      },

      // Transferencia: 2 notas distintas
      transfer: ()=>{
        const t = ctx.currentTime;
        [[523, 0],[784, 0.15]].forEach(([freq, delay])=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine'; osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.3, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      }
    };

    if(sounds[type]) sounds[type]();
  }catch(e){ console.warn('Audio error:', e); }
}

function toggleSound(){
  soundEnabled = !soundEnabled;
  localStorage.setItem('iv_sound', soundEnabled);
  const btn = document.getElementById('soundBtn');
  btn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  btn.classList.toggle('muted', !soundEnabled);
  if(soundEnabled){ playSound('save'); showNotif('Sonido activado', 'info', 'ğŸ”Š'); }
  else { showNotif('Sonido desactivado', 'info', 'ğŸ”‡'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANTALLA DE BIENVENIDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSplash(){
  // Actualizar botÃ³n segÃºn estado guardado
  if(!soundEnabled){
    document.getElementById('soundBtn').textContent = 'ğŸ”‡';
    document.getElementById('soundBtn').classList.add('muted');
  }

  setTimeout(()=>{
    const splash = document.getElementById('splash');
    splash.classList.add('hide');
    setTimeout(()=>{ splash.remove(); }, 700);
    // Sonido de bienvenida al entrar
    playSound('welcome');
    // NotificaciÃ³n de bienvenida
    setTimeout(()=>{
      const hour = new Date().getHours();
      const greet = hour<12 ? 'Â¡Buenos dÃ­as!' : hour<20 ? 'Â¡Buenas tardes!' : 'Â¡Buenas noches!';
      showNotif(greet + ' IsivoltPro listo', 'info', 'âš¡', 'Sistema cargado correctamente');
    }, 400);
  }, 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICACIONES MEJORADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNotif(msg, type='success', icon=null, sub=''){
  document.querySelectorAll('.notif').forEach(n=>n.remove());
  const icons = {success:'âœ…', error:'âŒ', warning:'âš ï¸', info:'â„¹ï¸'};
  const ic = icon || icons[type] || 'âœ…';
  const n = document.createElement('div');
  n.className = `notif ${type}`;
  n.innerHTML = `
    <div class="notif-icon">${ic}</div>
    <div style="flex:1">
      <div class="notif-text">${msg}</div>
      ${sub ? `<div class="notif-sub">${sub}</div>` : ''}
    </div>
    <button class="notif-close" onclick="this.parentElement.remove()">âœ•</button>`;
  document.body.appendChild(n);
  // Sonido automÃ¡tico segÃºn tipo
  if(type==='error') playSound('error');
  if(type==='warning') playSound('alert');
  setTimeout(()=>{
    n.style.animation = 'slideIn .3s ease reverse';
    setTimeout(()=>n.remove(), 280);
  }, 4500);
}

function downloadApp(){
  const a=document.createElement('a');
  a.href=location.href; a.download='IsivoltPro.html'; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¸ CAPTURA DE FOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPhoto = null;

function capturePhoto(){
  document.getElementById('photoInput').click();
}

function handlePhotoSelected(e){
  const file = e.target.files[0];
  if(!file) return;
  
  // Comprimir y convertir a base64
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 800;
      const MAX_HEIGHT = 800;
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > MAX_WIDTH) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width *= MAX_HEIGHT / height;
          height = MAX_HEIGHT;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      currentPhoto = canvas.toDataURL('image/jpeg', 0.7);
      
      // Mostrar preview
      const preview = document.getElementById('photoPreview');
      const placeholder = document.getElementById('photoPlaceholder');
      const capture = document.getElementById('photoCapture');
      
      preview.src = currentPhoto;
      preview.style.display = 'block';
      placeholder.style.display = 'none';
      capture.classList.add('has-photo');
      
      playSound('save');
      showNotif('Foto capturada', 'success', 'ğŸ“·', 'Se guardarÃ¡ con el material');
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function showImageModal(photoData){
  if(!photoData) return;
  document.getElementById('imgModalImg').src = photoData;
  document.getElementById('imgModal').classList.add('active');
}

function closeImageModal(){
  document.getElementById('imgModal').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š CÃ“DIGO DE BARRAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scannerType = 'qr'; // 'qr' o 'barcode'
let quaggaRunning = false;

function setScannerType(type){
  scannerType = type;
  document.getElementById('scan-qr-btn').classList.toggle('active', type==='qr');
  document.getElementById('scan-barcode-btn').classList.toggle('active', type==='barcode');
  
  if(type==='qr'){
    document.getElementById('scan-title').textContent = 'Escanear CÃ³digo QR';
    document.getElementById('scan-subtitle').textContent = 'Escanea el QR de un material';
  } else {
    document.getElementById('scan-title').textContent = 'Escanear CÃ³digo de Barras';
    document.getElementById('scan-subtitle').textContent = 'Escanea el cÃ³digo de barras (EAN, UPC, Code128...)';
  }
  
  if(scanning) stopScanning();
}

// Modificar startScanning para soportar barcode
const originalStartScanning = startScanning;
startScanning = async function(){
  if(scannerType === 'barcode'){
    await startBarcodeScanning();
  } else {
    await originalStartScanning();
  }
};

const originalStopScanning = stopScanning;
stopScanning = function(){
  if(quaggaRunning){
    stopBarcodeScanning();
  } else {
    originalStopScanning();
  }
};

async function startBarcodeScanning(){
  if(typeof Quagga === 'undefined'){
    showNotif('Cargando lector de cÃ³digos de barras...', 'info');
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  const vid = document.getElementById('video');
  vid.style.display = 'block';
  document.getElementById('startScanBtn').style.display = 'none';
  document.getElementById('stopScanBtn').style.display = 'block';
  
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: vid,
      constraints: {
        facingMode: "environment"
      }
    },
    decoder: {
      readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "upc_reader"]
    }
  }, (err) => {
    if (err) {
      handleCamError(err, 'scanResult', 'startScanBtn');
      return;
    }
    Quagga.start();
    quaggaRunning = true;
  });

  Quagga.onDetected((result) => {
    if (result && result.codeResult && result.codeResult.code) {
      playSound('scan');
      handleBarcode(result.codeResult.code);
    }
  });
}

function stopBarcodeScanning(){
  if(quaggaRunning){
    Quagga.stop();
    quaggaRunning = false;
  }
  document.getElementById('video').style.display = 'none';
  document.getElementById('startScanBtn').style.display = 'block';
  document.getElementById('stopScanBtn').style.display = 'none';
}

function handleBarcode(code){
  stopBarcodeScanning();
  
  // Buscar herramienta por cÃ³digo de barras guardado
  const tool = tools.find(t => t.barcode === code);
  
  if(tool){
    openMovementModal(tool);
  } else {
    // Preguntar si quiere crear nueva herramienta con este barcode
    showNotif(`CÃ³digo: ${code}`, 'warning', 'ğŸ“Š', 'No se encontrÃ³ este cÃ³digo. Â¿Quieres aÃ±adirlo?');
    document.getElementById('scanResult').innerHTML = `
      <div style="background:#fff3e0;border:2px solid #ffb74d;border-radius:12px;padding:16px;margin-top:14px">
        <div style="font-weight:700;color:#e65100;margin-bottom:8px">ğŸ“Š CÃ³digo de barras: ${code}</div>
        <div style="font-size:13px;color:#666;margin-bottom:12px">Este cÃ³digo no estÃ¡ registrado en el sistema</div>
        <button class="btn btn-primary btn-full" onclick="openAddToolWithBarcode('${code}')">â• Crear Material con este cÃ³digo</button>
      </div>`;
  }
}

function openAddToolWithBarcode(barcode){
  openAddTool();
  document.getElementById('t-code').value = barcode;
  document.getElementById('scanResult').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“… MANTENIMIENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkMaintenance(tool){
  if(!tool.maintenanceMonths) return null;
  if(!tool.lastMaintenance) tool.lastMaintenance = tool.id; // Usar fecha de creaciÃ³n como inicial
  
  const lastDate = new Date(parseInt(tool.lastMaintenance));
  const now = new Date();
  const monthsDiff = (now - lastDate) / (1000 * 60 * 60 * 24 * 30);
  
  if(monthsDiff >= tool.maintenanceMonths){
    const overdue = Math.floor(monthsDiff - tool.maintenanceMonths);
    return { status: 'due', text: `Vencido ${overdue}m`, overdue };
  } else {
    const remaining = Math.ceil(tool.maintenanceMonths - monthsDiff);
    if(remaining <= 1) return { status: 'soon', text: `En ${remaining}m` };
    return { status: 'ok', text: `OK (${remaining}m)` };
  }
}

function registerMaintenance(toolId){
  const tool = tools.find(t => t.id === toolId);
  if(!tool) return;
  
  tool.lastMaintenance = Date.now().toString();
  if(!tool.maintenanceHistory) tool.maintenanceHistory = [];
  tool.maintenanceHistory.push({
    date: new Date().toISOString(),
    notes: 'Mantenimiento registrado'
  });
  
  save();
  playSound('save');
  showNotif(`Mantenimiento registrado: ${tool.name}`, 'success', 'ğŸ”§', 'PrÃ³xima revisiÃ³n programada');
  renderTools();
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“± PWA â€” INSTALACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostrar prompt de instalaciÃ³n despuÃ©s de 3 segundos
  setTimeout(() => {
    document.getElementById('installPrompt').classList.add('show');
  }, 3000);
});

document.getElementById('installBtn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    playSound('save');
    showNotif('IsivoltPro instalado', 'success', 'ğŸ“±', 'Abre desde tu pantalla de inicio');
  }
  
  deferredPrompt = null;
  document.getElementById('installPrompt').classList.remove('show');
});

window.addEventListener('appinstalled', () => {
  showNotif('Â¡InstalaciÃ³n completada!', 'success', 'âœ…', 'Ya puedes abrir IsivoltPro desde tu pantalla de inicio');
  deferredPrompt = null;
});

// Generar manifest.json dinÃ¡mico
const manifestData = {
  name: "IsivoltPro",
  short_name: "IsivoltPro",
  description: "Control inteligente de inventario con QR",
  start_url: "./",
  display: "standalone",
  background_color: "#1e3c72",
  theme_color: "#1e3c72",
  orientation: "portrait",
  icons: [
    {
      src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%231e3c72'/><text y='400' x='256' text-anchor='middle' font-size='360' fill='white'>âš¡</text></svg>",
      sizes: "512x512",
      type: "image/svg+xml",
      purpose: "any maskable"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”” NOTIFICACIONES PUSH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requestNotificationPermission(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'granted') return;
  if(Notification.permission !== 'denied'){
    Notification.requestPermission().then(permission => {
      if(permission === 'granted'){
        showNotif('Notificaciones activadas', 'success', 'ğŸ””', 'Te avisaremos de herramientas pendientes');
      }
    });
  }
}

function sendNotification(title, body){
  if(!('Notification' in window)) return;
  if(Notification.permission !== 'granted') return;
  
  try {
    new Notification(title, {
      body,
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e3c72'/><text y='75' x='50' text-anchor='middle' font-size='60' fill='white'>âš¡</text></svg>",
      badge: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>âš¡</text></svg>",
      vibrate: [200, 100, 200],
      tag: 'isivoltpro'
    });
  } catch(e) { console.log('Notification error:', e); }
}

function checkPendingTools(){
  const now = new Date();
  const pending = [];
  
  history.forEach(h => {
    if(h.type !== 'out') return;
    const tool = tools.find(t => t.id === h.toolId);
    if(!tool || tool.status !== 'out') return;
    
    const days = Math.floor((now - new Date(h.date)) / 864e5);
    if(days >= 7) pending.push({tool, worker: workers.find(w=>w.id===h.workerId), days});
  });
  
  if(pending.length > 0){
    const msg = `${pending.length} herramienta${pending.length>1?'s':''} sin devolver`;
    sendNotification('âš ï¸ AtenciÃ³n IsivoltPro', msg);
  }
}

// Pedir permiso despuÃ©s de 10 segundos de uso
setTimeout(() => {
  if(localStorage.getItem('iv_notif_asked') !== 'true'){
    requestNotificationPermission();
    localStorage.setItem('iv_notif_asked', 'true');
  }
}, 10000);

// Revisar herramientas pendientes cada hora si la app estÃ¡ abierta
setInterval(checkPendingTools, 3600000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENÃš CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettingsMenu(){
  const menu = document.getElementById('settingsMenu');
  menu.classList.toggle('show');
  
  // Actualizar estado del sonido
  document.getElementById('sound-icon-menu').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  document.getElementById('sound-status-menu').textContent = soundEnabled ? 'Activado' : 'Desactivado';
}

function closeSettingsMenu(){
  document.getElementById('settingsMenu').classList.remove('show');
}

// Cerrar menÃº al hacer click fuera
document.addEventListener('click', (e) => {
  const menu = document.getElementById('settingsMenu');
  const isSettings = e.target.closest('.settings-menu') || e.target.textContent === 'âš™ï¸';
  if (!isSettings && menu.classList.contains('show')) {
    closeSettingsMenu();
  }
});

function clearAllData(){
  if(!confirm('âš ï¸ Â¿BORRAR TODOS LOS DATOS?\n\nEsto eliminarÃ¡:\nâ€¢ Todos los materiales\nâ€¢ Todo el personal\nâ€¢ Todo el historial\n\nEsta acciÃ³n NO se puede deshacer.')) return;
  if(!confirm('Â¿EstÃ¡s COMPLETAMENTE seguro? Esta es tu Ãºltima oportunidad.')) return;
  
  localStorage.clear();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”„ GOOGLE DRIVE SINCRONIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GDRIVE_CLIENT_ID = ''; // Usuario debe configurar su propia API
const GDRIVE_API_KEY = '';
const GDRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
const GDRIVE_FOLDER_NAME = 'IsivoltPro_Backups';

let gdriveToken = localStorage.getItem('iv_gdrive_token');
let gdriveConnected = !!gdriveToken;
let lastSyncTime = localStorage.getItem('iv_last_sync');

function openGDriveSync(){
  document.getElementById('gdriveModal').classList.add('active');
  updateGDriveStatus();
  closeSettingsMenu();
}

function updateGDriveStatus(){
  const status = document.getElementById('gdriveStatus');
  const icon = document.getElementById('gdriveStatusIcon');
  const title = document.getElementById('gdriveStatusTitle');
  const desc = document.getElementById('gdriveStatusDesc');
  
  if(gdriveConnected){
    status.className = 'gdrive-status connected';
    icon.textContent = 'âœ…';
    title.textContent = 'Conectado';
    desc.textContent = lastSyncTime ? `Ãšltima sincronizaciÃ³n: ${new Date(parseInt(lastSyncTime)).toLocaleString('es-ES')}` : 'Listo para sincronizar';
  } else {
    status.className = 'gdrive-status';
    icon.textContent = 'â˜ï¸';
    title.textContent = 'No conectado';
    desc.textContent = 'Conecta para hacer backup automÃ¡tico';
  }
}

async function connectGoogleDrive(){
  showNotif('Conectando con Google Drive...', 'info', 'â˜ï¸');
  
  // MODO DEMO: Como no tenemos API key real, simulamos
  if(!GDRIVE_CLIENT_ID){
    showNotif('ConfiguraciÃ³n de Google Drive', 'warning', 'â„¹ï¸', 'Para usar esta funciÃ³n necesitas configurar tu API key');
    
    // Mostrar instrucciones
    document.getElementById('gdriveActions').innerHTML = `
      <div style="background:#fff3e0;border:2px solid #ffb74d;border-radius:12px;padding:16px;text-align:left;margin-bottom:16px">
        <div style="font-weight:700;color:#e65100;margin-bottom:10px">ğŸ“‹ CÃ³mo configurar Google Drive API</div>
        <ol style="font-size:13px;color:#666;line-height:1.8;margin:0;padding-left:20px">
          <li>Ve a <a href="https://console.cloud.google.com" target="_blank" style="color:#1e3c72">Google Cloud Console</a></li>
          <li>Crea un proyecto nuevo</li>
          <li>Activa "Google Drive API"</li>
          <li>Crea credenciales OAuth 2.0</li>
          <li>Copia Client ID y API Key</li>
          <li>PÃ©galos en el cÃ³digo (lÃ­neas 1950-1951)</li>
        </ol>
        <button class="btn btn-primary btn-full" style="margin-top:12px" onclick="useDemoMode()">
          ğŸ”„ Usar Modo Demo (sin Google Drive)
        </button>
      </div>
    `;
    return;
  }
  
  // AquÃ­ irÃ­a la conexiÃ³n real con gapi.auth2
  // Por ahora modo demo
  gdriveConnected = true;
  gdriveToken = 'demo_token_'+Date.now();
  localStorage.setItem('iv_gdrive_token', gdriveToken);
  updateGDriveStatus();
  
  playSound('save');
  showNotif('Google Drive conectado', 'success', 'âœ…', 'Backup automÃ¡tico activado');
}

function useDemoMode(){
  showNotif('Modo Demo activado', 'info', 'ğŸ’¾', 'Backups locales habilitados');
  closeModal('gdriveModal');
}

async function manualBackup(){
  showSyncIndicator('Creando backup...');
  
  const backup = {
    version: '5.0',
    timestamp: Date.now(),
    data: {
      tools: tools,
      workers: workers,
      history: history
    },
    stats: {
      totalTools: tools.length,
      totalWorkers: workers.length,
      totalHistory: history.length
    }
  };
  
  // Descargar como JSON
  const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `IsivoltPro_Backup_${new Date().toLocaleDateString('es-ES').replace(/\//g,'-')}.json`;
  a.click();
  
  localStorage.setItem('iv_last_sync', Date.now().toString());
  lastSyncTime = Date.now().toString();
  
  hideSyncIndicator();
  playSound('save');
  showNotif('Backup descargado', 'success', 'ğŸ’¾', `${history.length} movimientos guardados`);
  updateGDriveStatus();
}

function restoreFromBackup(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const backup = JSON.parse(ev.target.result);
        
        if(!backup.data || !backup.data.tools || !backup.data.workers || !backup.data.history){
          throw new Error('Formato de backup invÃ¡lido');
        }
        
        if(!confirm(`âš ï¸ Â¿Restaurar este backup?\n\nFecha: ${new Date(backup.timestamp).toLocaleString('es-ES')}\n${backup.stats.totalTools} materiales\n${backup.stats.totalWorkers} personal\n${backup.stats.totalHistory} movimientos\n\nÂ¡Esto REEMPLAZARÃ todos tus datos actuales!`)){
          return;
        }
        
        tools = backup.data.tools;
        workers = backup.data.workers;
        history = backup.data.history;
        save();
        
        playSound('checkin');
        showNotif('Backup restaurado', 'success', 'âœ…', 'Datos cargados correctamente');
        
        closeModal('gdriveModal');
        renderDashboard();
        renderTools();
        renderWorkers();
        renderHistory();
        
      } catch(error) {
        showNotif('Error al restaurar backup', 'error', 'âŒ', error.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function showSyncIndicator(text){
  const indicator = document.getElementById('syncIndicator');
  document.getElementById('syncText').textContent = text;
  indicator.classList.add('show');
}

function hideSyncIndicator(){
  setTimeout(() => {
    document.getElementById('syncIndicator').classList.remove('show');
  }, 1500);
}

// Auto-backup cada hora si estÃ¡ conectado
setInterval(() => {
  if(gdriveConnected && tools.length > 0){
    // En producciÃ³n real aquÃ­ se subirÃ­a a Drive
    localStorage.setItem('iv_last_sync', Date.now().toString());
    lastSyncTime = Date.now().toString();
    console.log('Auto-backup realizado');
  }
}, 3600000); // cada hora

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderDashboard();
initSplash();

// Revisar pendientes al iniciar
setTimeout(checkPendingTools, 5000);
</script>
</body>
</html>
