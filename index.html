<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IsivoltPro - Gesti√≥n Total</title>

<meta name="theme-color" content="#1e3c72">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1086/1086581.png">
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1086/1086581.png">

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ‚îÄ‚îÄ ESTILOS BASE ‚îÄ‚îÄ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f4f6f9;min-height:100vh;color:#333;padding-bottom:90px;overscroll-behavior-y:none}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-overlay{position:fixed;inset:0;background:#1e3c72;z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s}
#login-overlay.hidden{opacity:0;pointer-events:none}
.login-box{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);padding:30px;border-radius:20px;text-align:center;width:90%;max-width:320px;box-shadow:0 20px 50px rgba(0,0,0,.3)}
.pin-dots{display:flex;justify-content:center;gap:15px;margin:20px 0}
.pin-dot{width:15px;height:15px;border-radius:50%;background:rgba(255,255,255,.3);transition:background .2s}
.pin-dot.active{background:#fff;transform:scale(1.2)}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}
.num-btn{background:rgba(255,255,255,.1);border:none;color:#fff;font-size:20px;padding:15px;border-radius:50%;cursor:pointer;transition:background .2s}
.num-btn:active{background:rgba(255,255,255,.3)}

/* ‚îÄ‚îÄ UI HEADER & NAV ‚îÄ‚îÄ */
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,.15);display:flex;justify-content:space-between;align-items:center}
.app-title{color:#fff;font-size:18px;font-weight:800;letter-spacing:0.5px}
.btn-icon{background:rgba(255,255,255,.2);border:none;color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer}

.nav-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:12px 0;box-shadow:0 -5px 20px rgba(0,0,0,.05);z-index:90;border-top:1px solid #eee;padding-bottom:max(12px, env(safe-area-inset-bottom))}
.nav-item{border:none;background:none;color:#999;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;width:100%}
.nav-item.active{color:#1e3c72;font-weight:700}
.nav-icon{font-size:22px;margin-bottom:2px}

/* ‚îÄ‚îÄ VISTAS Y TARJETAS ‚îÄ‚îÄ */
.view{display:none;padding:20px;max-width:800px;margin:0 auto;animation:fadeIn .3s ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.card{background:#fff;border-radius:16px;padding:18px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.04)}

/* KPI GRID */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px}
.kpi-box{background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;text-align:center}
.kpi-val{font-size:20px;font-weight:bold}
.kpi-lbl{font-size:10px;opacity:0.8}

/* LISTA ITEMS */
.item-card{display:flex;gap:12px;padding:12px;border-bottom:1px solid #f0f0f0;align-items:center}
.item-img-box{width:55px;height:55px;background:#f0f4f8;border-radius:10px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:24px}
.item-img{width:100%;height:100%;object-fit:cover}
.item-info{flex:1;min-width:0}
.item-name{font-weight:700;font-size:15px;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge-loc{background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:4px;font-size:10px;display:inline-block;margin-top:2px}
.stock-val{font-size:16px;font-weight:800;color:#1e3c72}
.stock-val.low{color:#c0392b}

/* BOTONES Y FORMULARIOS */
.fab{position:fixed;bottom:90px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 10px 25px rgba(39,174,96,.4);cursor:pointer;z-index:95;transition:transform .2s}
.fab:active{transform:scale(0.9)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:#fff;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:24px;max-height:90vh;overflow-y:auto;animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

.form-input{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#f9f9f9;margin-bottom:15px;transition:0.2s}
.form-input:focus{background:#fff;border-color:#1e3c72;outline:none}
.settings-btn{width:100%;padding:14px;background:#fff;border:1px solid #eee;border-radius:12px;margin-bottom:10px;text-align:left;font-weight:600;display:flex;align-items:center;gap:10px;color:#333;cursor:pointer}
.settings-btn.primary{background:#1e3c72;color:#fff;border:none}
.settings-btn.danger{background:#ffebee;color:#c0392b;border:none}
.cat-pill{padding:6px 12px;border-radius:15px;font-size:12px;background:#eee;border:none;cursor:pointer}
.cat-pill.active{background:#1e3c72;color:#fff}
</style>
</head>
<body>

<div id="login-overlay">
  <div class="login-box">
    <div style="font-size:40px;margin-bottom:10px">‚ö°</div>
    <h3>IsivoltPro</h3>
    <p style="font-size:12px;opacity:0.7;margin-bottom:20px">Sistema de Gesti√≥n</p>
    <div class="pin-dots">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad" id="numpad"></div>
    <p style="margin-top:20px;font-size:10px;opacity:0.4">PIN por defecto: 1234</p>
  </div>
</div>

<header class="header">
  <div class="app-title">IsivoltPro</div>
  <div class="header-actions">
    <button onclick="renderSettings()" class="btn-icon">‚öôÔ∏è</button>
  </div>
</header>

<main>
  <div id="view-dash" class="view active">
    <div class="card" style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:25px">
      <h2 style="font-size:18px;opacity:0.9">Resumen Global</h2>
      <div class="kpi-grid">
        <div class="kpi-box"><div id="kpi-total" class="kpi-val">0</div><div class="kpi-lbl">ITEMS</div></div>
        <div class="kpi-box"><div id="kpi-value" class="kpi-val">0‚Ç¨</div><div class="kpi-lbl">VALOR</div></div>
        <div class="kpi-box"><div id="kpi-low" class="kpi-val" style="color:#ff8a80">0</div><div class="kpi-lbl">BAJO</div></div>
        <div class="kpi-box"><div id="kpi-loan" class="kpi-val" style="color:#81d4fa">0</div><div class="kpi-lbl">PRESTADO</div></div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <button onclick="openModal()" class="card" style="display:flex;align-items:center;gap:10px;border:none;cursor:pointer;margin:0">
        <span style="font-size:24px;background:#e8f5e9;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%">‚ûï</span>
        <div style="text-align:left"><div style="font-weight:bold">Nuevo</div><div style="font-size:10px;color:#666">Material</div></div>
      </button>
      <button onclick="startScan()" class="card" style="display:flex;align-items:center;gap:10px;border:none;cursor:pointer;margin:0">
        <span style="font-size:24px;background:#e3f2fd;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%">üì∑</span>
        <div style="text-align:left"><div style="font-weight:bold">Escanear</div><div style="font-size:10px;color:#666">C√≥digo QR</div></div>
      </button>
    </div>
  </div>

  <div id="view-items" class="view">
    <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:10px;margin-bottom:5px" id="cat-filters">
      <button class="cat-pill active" onclick="filterCat('all', this)">Todo</button>
      <button class="cat-pill" onclick="filterCat('Herramientas', this)">Herramientas</button>
      <button class="cat-pill" onclick="filterCat('Material', this)">Material</button>
      <button class="cat-pill" onclick="filterCat('Seguridad', this)">Seguridad</button>
      <button class="cat-pill" onclick="filterCat('Consumibles', this)">Consumibles</button>
    </div>
    
    <input type="text" id="search-input" placeholder="üîç Buscar material, ubicaci√≥n..." class="form-input" onkeyup="renderList()">
    <div class="card" style="padding:0;overflow:hidden" id="inventory-list"></div>
  </div>

  <div id="view-scan" class="view">
    <div class="card">
      <h3 style="text-align:center;margin-bottom:15px">Esc√°ner Activo</h3>
      <div style="position:relative;height:300px;background:#000;border-radius:12px;overflow:hidden">
        <video id="qr-video" style="width:100%;height:100%;object-fit:cover"></video>
        <div style="position:absolute;inset:0;border:2px solid rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center">
          <div style="width:200px;height:200px;border:2px solid #2ecc71;border-radius:20px;box-shadow:0 0 0 999px rgba(0,0,0,0.5)"></div>
        </div>
      </div>
      <button onclick="stopScan()" class="settings-btn danger" style="justify-content:center;margin-top:15px">Cancelar Esc√°ner</button>
    </div>
  </div>

  <div id="view-settings" class="view">
    
    <div class="card" style="border-left:5px solid #27ae60">
      <h3 style="margin-bottom:5px">üíæ COPIA DE SEGURIDAD</h3>
      <p style="font-size:12px;color:#666;margin-bottom:15px">Guarda tus datos (incluidas las fotos) para no perderlos.</p>
      
      <button onclick="backupSystem()" class="settings-btn primary">
        <i>‚¨áÔ∏è</i> Descargar Copia COMPLETA (.isv)
      </button>
      
      <button onclick="document.getElementById('restore-file').click()" class="settings-btn danger" style="background:#fff;border:1px solid #c0392b;color:#c0392b">
        <i>‚¨ÜÔ∏è</i> Restaurar Copia Completa
      </button>
      <input type="file" id="restore-file" hidden accept=".isv,.json" onchange="restoreSystem(this)">
    </div>

    <div class="card">
      <h3>üìä Oficina y Excel</h3>
      <p style="font-size:12px;color:#666;margin-bottom:15px">Exportar listado para administraci√≥n.</p>
      <button onclick="exportToExcel()" class="settings-btn"><i>üìÑ</i> Exportar a Excel</button>
      <div style="border-top:1px solid #eee;padding-top:10px;margin-top:10px">
        <button onclick="document.getElementById('import-excel').click()" class="settings-btn"><i>üì•</i> Importar desde Excel</button>
        <input type="file" id="import-excel" hidden accept=".xlsx,.xls" onchange="importFromExcel(this)">
        <p style="font-size:10px;color:#c0392b">‚ö†Ô∏è Importar Excel no recupera las fotos, solo datos.</p>
      </div>
    </div>

    <div class="card">
      <h3>Seguridad</h3>
      <button onclick="changePin()" class="settings-btn"><i>üîí</i> Cambiar PIN de Acceso</button>
      <div style="font-size:10px;text-align:center;margin-top:10px;color:#999">Versi√≥n 3.0 Pro</div>
    </div>
  </div>
</main>

<div class="modal-overlay" id="item-modal">
  <div class="modal-sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3 id="modal-title">Material</h3>
      <button onclick="deleteItem()" style="border:none;background:none;color:#c0392b;font-weight:bold;font-size:12px">ELIMINAR</button>
    </div>
    <input type="hidden" id="item-id">
    
    <div onclick="document.getElementById('photo-input').click()" style="width:100%;height:120px;background:#f0f4f8;border:2px dashed #ccc;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:15px;cursor:pointer">
      <img id="preview-img" style="width:100%;height:100%;object-fit:cover;display:none">
      <span id="preview-text" style="color:#999;font-size:12px;text-align:center">üì∑ Tocar para a√±adir foto</span>
    </div>
    <input type="file" id="photo-input" hidden accept="image/*" onchange="handlePhoto(this)">

    <input type="text" id="item-name" class="form-input" placeholder="Nombre del Material">
    
    <select id="item-cat" class="form-input">
      <option value="Herramientas">Herramientas</option>
      <option value="Material">Material El√©ctrico</option>
      <option value="Seguridad">Seguridad / EPIS</option>
      <option value="Consumibles">Consumibles</option>
      <option value="Varios">Varios</option>
    </select>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label style="font-size:11px;font-weight:bold;margin-left:5px">Stock Actual</label>
        <input type="number" id="item-stock" class="form-input">
      </div>
      <div>
        <label style="font-size:11px;font-weight:bold;margin-left:5px">Stock M√≠nimo</label>
        <input type="number" id="item-min" class="form-input">
      </div>
    </div>

    <input type="number" id="item-price" class="form-input" placeholder="Precio Unidad (‚Ç¨)">
    
    <div>
      <label style="font-size:11px;font-weight:bold;margin-left:5px">Ubicaci√≥n / Asignado a</label>
      <input type="text" id="item-assign" class="form-input" placeholder="Ej: Furgoneta 1, Juan...">
    </div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <button onclick="closeModal()" class="settings-btn" style="justify-content:center;background:#eee">Cancelar</button>
      <button onclick="saveItem()" class="settings-btn primary" style="justify-content:center">Guardar</button>
    </div>
  </div>
</div>

<nav class="nav-bar">
  <button class="nav-item active" onclick="switchTab('dash')">
    <span class="nav-icon">üìä</span> Inicio
  </button>
  <button class="nav-item" onclick="switchTab('items')">
    <span class="nav-icon">üì¶</span> Stock
  </button>
  <button class="nav-item" onclick="switchTab('settings')">
    <span class="nav-icon">üõ†</span> Ajustes
  </button>
</nav>
<div class="fab" onclick="openModal()">+</div>

<script>
/* ‚îÄ‚îÄ CONFIGURACI√ìN Y ESTADO ‚îÄ‚îÄ */
const DB_NAME = 'isivolt_pro_master';
let inventory = JSON.parse(localStorage.getItem(DB_NAME)) || [];
let pin = localStorage.getItem('isivolt_pin') || '1234';
let currentPin = '';
let currentFilter = 'all';

// Inicializar
window.onload = () => {
  renderNumpad();
  document.getElementById('login-overlay').style.display='flex'; // Forzar login
  updateDashboard();
  renderList();
  registerSW(); // Activar modo offline
};

/* ‚îÄ‚îÄ 1. SEGURIDAD (PIN) ‚îÄ‚îÄ */
function renderNumpad() {
  const p=document.getElementById('numpad'); p.innerHTML='';
  [1,2,3,4,5,6,7,8,9,'C',0,'OK'].forEach(n=>{
    const b=document.createElement('button'); b.className='num-btn'; b.innerText=n;
    b.onclick=()=>handlePin(n);
    if(n==='OK') b.style.background='#27ae60'; if(n==='C') b.style.background='#e74c3c';
    p.appendChild(b);
  });
}
function handlePin(k){
  if(k==='C') {currentPin=''; updateDots(); return;}
  if(k==='OK') {
    if(currentPin===pin) {
        document.getElementById('login-overlay').classList.add('hidden');
        setTimeout(()=>document.getElementById('login-overlay').style.display='none',500);
    } else {
        alert('PIN Incorrecto'); currentPin=''; updateDots();
    }
    return;
  }
  if(currentPin.length<4) {currentPin+=k; updateDots();}
  if(currentPin.length===4 && k!=='OK' && currentPin===pin) handlePin('OK');
}
function updateDots(){document.querySelectorAll('.pin-dot').forEach((d,i)=>d.classList.toggle('active',i<currentPin.length));}
function changePin(){const n=prompt("Nuevo PIN (4 d√≠gitos):"); if(n&&n.length===4){pin=n;localStorage.setItem('isivolt_pin',n);alert("PIN Cambiado");}}

/* ‚îÄ‚îÄ 2. NAVEGACI√ìN ‚îÄ‚îÄ */
function switchTab(t){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+t).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  event.currentTarget.classList.add('active');
  if(t==='items') renderList();
}
function renderSettings(){switchTab('settings');}

/* ‚îÄ‚îÄ 3. GESTI√ìN DE ITEMS ‚îÄ‚îÄ */
function saveItem(){
  const id = document.getElementById('item-id').value;
  const item = {
    id: id ? parseFloat(id) : Date.now(),
    name: document.getElementById('item-name').value,
    cat: document.getElementById('item-cat').value,
    stock: parseInt(document.getElementById('item-stock').value)||0,
    min: parseInt(document.getElementById('item-min').value)||0,
    price: parseFloat(document.getElementById('item-price').value)||0,
    assign: document.getElementById('item-assign').value,
    img: document.getElementById('photo-input').dataset.base64
  };

  if(!item.name) return alert("El nombre es obligatorio");

  if(id) {
    const idx = inventory.findIndex(i=>i.id==id);
    if(idx > -1) {
      if(!item.img) item.img = inventory[idx].img; // Mantener foto anterior si no se cambia
      inventory[idx] = item;
    }
  } else inventory.push(item);

  localStorage.setItem(DB_NAME, JSON.stringify(inventory));
  closeModal(); updateDashboard(); renderList();
}

function deleteItem(){
  if(confirm('¬øEliminar este material?')) {
    const id = document.getElementById('item-id').value;
    inventory = inventory.filter(i=>i.id!=id);
    localStorage.setItem(DB_NAME, JSON.stringify(inventory));
    closeModal(); updateDashboard(); renderList();
  }
}

function openModal(id){
  document.getElementById('item-modal').classList.add('open');
  // Reset fields
  document.getElementById('photo-input').value = '';
  delete document.getElementById('photo-input').dataset.base64;
  
  if(id) {
    const i = inventory.find(x=>x.id==id);
    document.getElementById('item-id').value=i.id;
    document.getElementById('modal-title').innerText="Editar Material";
    document.getElementById('item-name').value=i.name;
    document.getElementById('item-cat').value=i.cat;
    document.getElementById('item-stock').value=i.stock;
    document.getElementById('item-min').value=i.min;
    document.getElementById('item-price').value=i.price;
    document.getElementById('item-assign').value=i.assign;
    if(i.img) {
      document.getElementById('preview-img').src=i.img;
      document.getElementById('preview-img').style.display='block';
      document.getElementById('preview-text').style.display='none';
    } else {
      document.getElementById('preview-img').style.display='none';
      document.getElementById('preview-text').style.display='block';
    }
  } else {
    document.getElementById('item-id').value='';
    document.getElementById('modal-title').innerText="Nuevo Material";
    document.getElementById('item-name').value='';
    document.getElementById('item-stock').value='';
    document.getElementById('item-min').value='';
    document.getElementById('item-price').value='';
    document.getElementById('item-assign').value='';
    document.getElementById('preview-img').style.display='none';
    document.getElementById('preview-text').style.display='block';
  }
}
function closeModal(){document.getElementById('item-modal').classList.remove('open');}

/* ‚îÄ‚îÄ 4. RENDERIZADO DE LISTA Y DASHBOARD ‚îÄ‚îÄ */
function filterCat(c, btn){
  currentFilter=c; 
  document.querySelectorAll('.cat-pill').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderList();
}

function renderList(){
  const list = document.getElementById('inventory-list'); 
  list.innerHTML='';
  const term = document.getElementById('search-input').value.toLowerCase();
  
  const filtered = inventory.filter(i => {
    const matchesSearch = i.name.toLowerCase().includes(term) || (i.assign && i.assign.toLowerCase().includes(term));
    const matchesCat = currentFilter === 'all' || i.cat === currentFilter;
    return matchesSearch && matchesCat;
  });

  if(filtered.length === 0) list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">No hay resultados</div>';

  filtered.forEach(i=>{
    const div = document.createElement('div'); div.className='item-card';
    div.onclick=()=>openModal(i.id);
    div.innerHTML=`
      <div class="item-img-box">${i.img?`<img src="${i.img}" class="item-img">`:'üì¶'}</div>
      <div class="item-info">
        <div class="item-name">${i.name}</div>
        <div style="font-size:11px;color:#666">
          ${i.cat} ${i.assign?`<span class="badge-loc">${i.assign}</span>`:''}
        </div>
      </div>
      <div class="stock-val ${i.stock<=i.min?'low':''}">${i.stock}</div>
    `;
    list.appendChild(div);
  });
}

function updateDashboard(){
  document.getElementById('kpi-total').innerText = inventory.length;
  document.getElementById('kpi-low').innerText = inventory.filter(i=>i.stock<=i.min).length;
  document.getElementById('kpi-loan').innerText = inventory.filter(i=>i.assign).length;
  const val = inventory.reduce((acc, i) => acc + (i.stock * (i.price||0)), 0);
  document.getElementById('kpi-value').innerText = Math.round(val) + '‚Ç¨';
}

/* ‚îÄ‚îÄ 5. FOTOS (Compresi√≥n) ‚îÄ‚îÄ */
function handlePhoto(inp){
  if(inp.files && inp.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
       const img = new Image();
       img.onload = function(){
         const canvas = document.createElement('canvas');
         const ctx = canvas.getContext('2d');
         // Redimensionar a 300px ancho (ahorra mucha memoria)
         const scale = 300/img.width;
         canvas.width = 300;
         canvas.height = img.height * scale;
         ctx.drawImage(img,0,0,canvas.width,canvas.height);
         const b64 = canvas.toDataURL('image/jpeg',0.6);
         document.getElementById('preview-img').src=b64;
         document.getElementById('preview-img').style.display='block';
         document.getElementById('preview-text').style.display='none';
         document.getElementById('photo-input').dataset.base64=b64;
       };
       img.src=e.target.result;
    };
    reader.readAsDataURL(inp.files[0]);
  }
}

/* ‚îÄ‚îÄ 6. BACKUP Y EXCEL ‚îÄ‚îÄ */
// Backup Completo (.isv = JSON)
function backupSystem(){
  const dataStr = JSON.stringify(inventory);
  const blob = new Blob([dataStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const date = new Date().toISOString().slice(0,10);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Isivolt_Backup_${date}.isv`;
  link.click();
}

function restoreSystem(inp){
  const file = inp.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const data = JSON.parse(e.target.result);
      if(Array.isArray(data) && confirm(`Se restaurar√°n ${data.length} items. Esto sobrescribe lo actual. ¬øSeguro?`)){
        inventory = data;
        localStorage.setItem(DB_NAME, JSON.stringify(inventory));
        updateDashboard(); renderList();
        alert("Restauraci√≥n exitosa");
      }
    } catch(err){ alert("Archivo corrupto o inv√°lido"); }
  };
  reader.readAsText(file);
  inp.value='';
}

// Excel Export/Import
function exportToExcel(){
  const data = inventory.map(i=>({
    ID: i.id, Nombre: i.name, Categoria: i.cat, Stock: i.stock, 
    Minimo: i.min, Precio: i.price, Ubicacion: i.assign, Valor_Total: i.stock*i.price
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Inventario");
  XLSX.writeFile(wb, "Inventario_Isivolt.xlsx");
}

function importFromExcel(inp){
  const file = inp.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    if(json.length && confirm(`Importar ${json.length} items desde Excel? (Se perder√°n fotos)`)){
      inventory = json.map(row=>({
        id: row.ID || Date.now()+Math.random(),
        name: row.Nombre || row.name || 'Sin Nombre',
        cat: row.Categoria || 'Varios',
        stock: row.Stock || 0,
        min: row.Minimo || 0,
        price: row.Precio || 0,
        assign: row.Ubicacion || '',
        img: null
      }));
      localStorage.setItem(DB_NAME, JSON.stringify(inventory));
      updateDashboard(); renderList();
    }
  };
  reader.readAsArrayBuffer(file);
  inp.value='';
}

/* ‚îÄ‚îÄ 7. SCANNER QR ‚îÄ‚îÄ */
let video=document.getElementById('qr-video'), isScanning=false;
function startScan(){
  switchTab('scan'); isScanning=true;
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>{
    video.srcObject=s; video.setAttribute("playsinline", true); video.play();
    requestAnimationFrame(tickScan);
  });
}
function tickScan(){
  if(video.readyState===video.HAVE_ENOUGH_DATA && isScanning){
     const c=document.createElement("canvas");
     c.width=video.videoWidth; c.height=video.videoHeight;
     c.getContext("2d").drawImage(video,0,0);
     const i=c.getContext("2d").getImageData(0,0,c.width,c.height);
     const code=jsQR(i.data,i.width,i.height,{inversionAttempts:"dontInvert"});
     if(code){
       stopScan();
       const f=inventory.find(x=>x.id==code.data||x.name===code.data);
       if(f) openModal(f.id); else if(confirm('Item no encontrado. ¬øCrear nuevo?')) {openModal(); document.getElementById('item-name').value=code.data;}
     } else requestAnimationFrame(tickScan);
  } else if(isScanning) requestAnimationFrame(tickScan);
}
function stopScan(){
  isScanning=false; if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  switchTab('dash');
}

/* ‚îÄ‚îÄ 8. PWA SERVICE WORKER (OFFLINE) ‚îÄ‚îÄ */
function registerSW() {
  if ('serviceWorker' in navigator) {
    const swCode = `
      self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
      self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
      self.addEventListener('fetch', e => {
        e.respondWith(fetch(e.request).catch(() => {
          return new Response('Modo Offline: Sin conexi√≥n, pero la app sigue funcionando.', {headers: {'Content-Type': 'text/plain'}});
        }));
      });
    `;
    const blob = new Blob([swCode], {type: 'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob))
      .then(() => console.log('SW Registrado'))
      .catch(err => console.log('SW Error:', err));
  }
}
</script>
</body>
</html>
